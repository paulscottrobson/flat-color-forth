              	; --------------------------------------
              	; zasm: assemble "kernel.asm"
              	; date: 2018-12-14 07:45:01
              	; --------------------------------------


              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		kernel.asm
              	;		Author :	Paul Robson (paul@robsons.org.uk)
              	;		Date : 		12th December 2018
              	;		Purpose :	Flat Color Forth Kernel
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              	
              	;
              	;		Page allocation. These need to match up with those given in the page table
              	;		in data.asm
              	;													
0020:         	DictionaryPage = $20 								; dictionary page
0022:         	FirstSourcePage = $22 								; first page of 512 byte source pages
0004:         	SourcePageCount = 4 								; number of source pages (32 pages/page)
0200:         	EditPageSize = 512 									; bytes per edit page.
002A:         	FirstCodePage = $22+SourcePageCount*2 				; first code page.
              	;
              	;		Memory allocated from the Unused space in $4000-$7FFF
              	;
7B08:         	EditBuffer = $7B08 									; $7B00-$7D1F 512 byte edit buffer
7EFC:         	StackTop = $7EFC 									;      -$7EFC Top of stack
              	
8000:         			org 	$8000 								; $8000 boot.
8000: 1804    			jr 		Boot
8002: FFFF    			org 	$8004 								; $8004 address of sysinfo
8004: E38B    			dw 		SystemInformation 
              	
8006: 31FC7E  	Boot:	ld 		sp,StackTop							; reset Z80 Stack
8009: F3      			di											; disable interrupts
              		
800A: ED910702			db 		$ED,$91,7,2							; set turbo port (7) to 2 (14Mhz speed)
800E: 3E2A    			ld 		a,FirstCodePage 					; get the page to start
8010: CD4E83  			call 	PAGEInitialise
              	
8013: AF      			xor 	a 									; set Mode 0 (standard 48k Spectrum + Sprites)
8014: CDE281  			call 	GFXMode
8017: C32385  			jp 		BUFFScan 							; scan the buffers
              	
              			include "support/command.asm" 				; command line stuff
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		command.asm
              	;		Purpose:	Command line code
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              	
801A:         	CommandLineStart:
801A: 21D380  			ld 		hl,__CLIWelcome
801D: 0E05    			ld 		c,5
801F: 1809    			jr 		WarmStartSetup
8021:         	WarmStart:
8021: 21E480  			ld 		hl,__CLIWarmStart
8024: 0E04    			ld 		c,4
8026: 1802    			jr 		WarmStartSetup
8028:         	ErrorHandler:										; error routines.
8028: 0E02    			ld 		c,2
802A:         	WarmStartSetup:
802A: 31FC7E  			ld 		sp,StackTop							; reset Z80 Stack
              	
802D: 3E2A    			ld 		a,FirstCodePage 					; reset the paging system
802F: CD4E83  			call 	PAGEInitialise
8032: E5      			push 	hl 									; save error message
              	
8033: 2AFB8B  			ld 		hl,(__DIScreenSize) 				; clear the 2nd line
8036: 11C0FF  			ld 		de,-64
8039: 19      			add 	hl,de
803A: 0620    			ld 		b,32
803C:         	__CLIClear:
803C: 112001  			ld 		de,$0120
803F: CD1782  			call 	GFXWriteCharacter
8042: 23      			inc 	hl
8043: 10F7    			djnz 	__CLIClear
              	
8045: 2AFB8B  			ld 		hl,(__DIScreenSize) 				; half way down 2nd line.
8048: 11D0FF  			ld 		de,-48
804B: 19      			add 	hl,de
              	
804C: 51      			ld 		d,c 								; colour in D
804D: C1      			pop 	bc 									; text in BC
804E:         	__CLIPrompt: 										; write prompt / message / etc.
804E: 0A      			ld 		a,(bc)
804F: B7      			or 		a
8050: 280B    			jr 		z,__CLIPromptExit
8052: FA5D80  			jp 		m,__CLIPromptExit
8055: 5F      			ld 		e,a
8056: CD1782  			call 	GFXWriteCharacter
8059: 03      			inc 	bc
805A: 23      			inc 	hl
805B: 18F1    			jr 		__CLIPrompt
805D:         	__CLIPromptExit:
805D: 2A078C  			ld 		hl,(__ARegister) 					; load A/B in
8060: ED5B098C			ld 		de,(__BRegister) 					; update that part of the display.
8064: CDEA80  			call 	DEBUGShow
              	
8067: 2AFB8B  			ld 		hl,(__DIScreenSize)					; bakck to start of 2nd to last row
806A: 11C0FF  			ld		de,-64
806D: 19      			add 	hl,de
806E: DD21218C			ld 		ix,__CLIBuffer 						; IX points to buffer
8072:         	__CLILoop:
8072: 117F05  			ld 		de,$057F 							; display prompt
8075: CD1782  			call 	GFXWriteCharacter
8078: CDBC80  			call 	__CLIGetKey 						; get key
807B: FE0D    			cp 		13 									; exec on CR
807D: 281C    			jr 		z,__CLIExecute
807F: FE20    			cp 		' ' 								; exec on space
8081: 2818    			jr 		z,__CLIExecute
8083: DA2180  			jp 		c,WarmStart 						; any other < ' ' warm start e.g. start again
              	
8086: DD7700  			ld 		(ix+0),a 							; save char in buffer
8089: 1606    			ld 		d,6 								; draw it
808B: 5F      			ld 		e,a
808C: CD1782  			call 	GFXWriteCharacter
              	
808F: 7D      			ld 		a,l 								; reached 15 chars, don't add
8090: E60F    			and 	15
8092: FE0F    			cp 		15
8094: 28DC    			jr 		z,__CLILoop
8096: 23      			inc 	hl 									; move forward
8097: DD23    			inc 	ix
8099: 18D7    			jr 		__CLILoop
              	
809B:         	__CLIExecute:
809B: DD360080			ld 		(ix+0),$80 							; mark end
              	
809F: 01208C  			ld 		bc,__CLIBuffer-1 					; get address of buffer into BC
80A2: 7D      			ld 		a,l 								; get length
80A3: E60F    			and 	$0F 
80A5: F6C0    			or 		$C0 								; 1 10 lllll
80A7: 02      			ld 		(bc),a 								; make that the tag/
              	
80A8: 2A078C  			ld 		hl,(__ARegister) 					; Execute as a yellow word in context.
80AB: ED5B098C			ld 		de,(__BRegister)
80AF: CD0887  			call 	COMXExecuteYellowWord
80B2: ED53098C			ld 		(__BRegister),de
80B6: 22078C  			ld 		(__ARegister),hl		
80B9: C32180  			jp 		WarmStart
              	
80BC:         	__CLIGetKey:
80BC: CDC380  			call 	__CLIGetChange
80BF: B7      			or 		a
80C0: 28FA    			jr 		z,__CLIGetKey
80C2: C9      			ret
80C3:         	__CLIGetChange:
80C3: C5      			push 	bc
80C4: 3A1F8C  			ld 		a,(__CLICurrentKey)
80C7: 47      			ld 		b,a
80C8:         	__CLIChangeLoop:
80C8: CD8182  			call 	IOScanKeyboard
80CB: B8      			cp 		b
80CC: 28FA    			jr 		z,__CLIChangeLoop
80CE: 321F8C  			ld 		(__CLICurrentKey),a
80D1: C1      			pop 	bc
80D2: C9      			ret
              	
80D3:         	__CLIWelcome:
80D3: 666C6174			db 		"flat.color.forth",$00
80D7: 2E636F6C	
80DB: 6F722E66	
80DF: 6F727468	
80E3: 00      	
80E4:         	__CLIWarmStart:
80E4: 72656164			db 		"ready",$00
80E8: 7900    	
              			include "support/debug.asm"					; display stack on bottom line.		
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		debug.asm
              	;		Purpose:	Show A/B Registers on the screen.
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              	
80EA:         	DEBUGShow:
80EA: C5      			push 	bc
80EB: D5      			push 	de
80EC: E5      			push 	hl 					
              	
80ED: D5      			push 	de 									; save B then A
80EE: E5      			push 	hl
              	
80EF: 2AFB8B  			ld 		hl,(__DIScreenSize) 				; clear bottom line.
80F2: 11E0FF  			ld 		de,-32
80F5: 19      			add 	hl,de
80F6: E5      			push 	hl
80F7: 0620    			ld 		b,32
80F9:         	__DEBUGShowClear:
80F9: 112006  			ld 		de,$0620
80FC: CD1782  			call 	GFXWriteCharacter
80FF: 23      			inc 	hl
8100: 10F7    			djnz 	__DEBUGShowClear
              	
8102: E1      			pop 	hl 									; HL now points to start of bottom line
              	
8103: 114105  			ld 		de,$0500+'A'
8106: CD1782  			call 	GFXWriteCharacter
8109: 23      			inc 	hl
810A: 113A05  			ld 		de,$0500+':'
810D: CD1782  			call 	GFXWriteCharacter
8110: 23      			inc 	hl
8111: D1      			pop 	de 									; get pushed A
8112: CD2C81  			call 	__DEBUGPrintDecimalInteger 			; print DE at position HL, C Chars remaining.
8115: 23      			inc 	hl 									; allow a space
              	
8116: 114205  			ld 		de,$0500+'B'
8119: CD1782  			call 	GFXWriteCharacter
811C: 23      			inc 	hl
811D: 113A05  			ld 		de,$0500+':'
8120: CD1782  			call 	GFXWriteCharacter
8123: 23      			inc 	hl
8124: D1      			pop 	de 									; get pushed B
8125: CD2C81  			call 	__DEBUGPrintDecimalInteger 			; print DE at position HL, C Chars remaining.
              	
8128: E1      			pop 	hl 									
8129: D1      			pop 	de 									
812A: C1      			pop 	bc
812B: C9      			ret
              	
812C:         	__DEBUGPrintDecimalInteger:
812C: D5      			push 	de
812D: CB7A    			bit 	7,d 								; is it negative.
812F: 2807    			jr 		z,__DEBUGPrintDecNotNegative
8131: 7A      			ld 		a,d 								; if so, negate the value.
8132: 2F      			cpl
8133: 57      			ld 		d,a
8134: 7B      			ld 		a,e
8135: 2F      			cpl
8136: 5F      			ld 		e,a
8137: 13      			inc 	de
8138:         	__DEBUGPrintDecNotNegative:
8138: CD4781  			call 	__DEBUGPrintDERecursively
              	
813B: D1      			pop 	de
813C: CB7A    			bit 	7,d 								; was it -VE
813E: C8      			ret 	z
813F: 112D06  			ld 		de,$0600+'-'						; print a -ve sign
8142: CD1782  			call 	GFXWriteCharacter
8145: 23      			inc 	hl
8146: C9      			ret
              	
8147:         	__DEBUGPrintDERecursively:
8147: E5      			push 	hl 									; save screen position
8148: 210A00  			ld 		hl,10 								; divide by 10, DE is division, HL is remainder.
814B: CD7A81  			call 	DIVDivideMod16
814E: E3      			ex 		(sp),hl 							; remainder on TOS, HL contains screen position
814F: 7A      			ld 		a,d 								; if DE is non zero call Recursively
8150: B3      			or 		e
8151: C44781  			call 	nz,__DEBUGPrintDERecursively
8154: D1      			pop 	de 									; DE = remainder
8155: 7B      			ld 		a,e 								; convert E to a character
8156: F630    			or 		'0'
8158: 5F      			ld 		e,a
8159: 1606    			ld 		d,6 								; yellow
815B: CD1782  			call 	GFXWriteCharacter 					; write digit.
815E: 23      			inc 	hl 	
815F: C9      			ret
              			include "support/multiply.asm" 				; 16 bit multiply (not used in kernel)
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		multiply.asm
              	;		Purpose:	16 bit unsigned multiply
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              	
              	; *********************************************************************************
              	;
              	;								Does HL = HL * DE
              	;
              	; *********************************************************************************
              	
8160:         	MULTMultiply16:
8160: C5      			push 	bc
8161: D5      			push 	de
8162: 44      			ld 		b,h 							; get multipliers in DE/BC
8163: 4D      			ld 		c,l
8164: 210000  			ld 		hl,0 							; zero total
8167:         	__Core__Mult_Loop:
8167: CB41    			bit 	0,c 							; lsb of shifter is non-zero
8169: 2801    			jr 		z,__Core__Mult_Shift
816B: 19      			add 	hl,de 							; add adder to total
816C:         	__Core__Mult_Shift:
816C: CB38    			srl 	b 								; shift BC right.
816E: CB19    			rr 		c
8170: EB      			ex 		de,hl 							; shift DE left
8171: 29      			add 	hl,hl
8172: EB      			ex 		de,hl
8173: 78      			ld 		a,b 							; loop back if BC is nonzero
8174: B1      			or 		c
8175: 20F0    			jr 		nz,__Core__Mult_Loop
8177: D1      			pop 	de
8178: C1      			pop 	bc
8179: C9      			ret
              	
              			include "support/divide.asm" 				; 16 bit divide (not used in kernel)
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		divide.asm
              	;		Purpose:	16 bit unsigned divide
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              	
              	; *********************************************************************************
              	;
              	;			Calculates DE / HL. On exit DE = result, HL = remainder
              	;
              	; *********************************************************************************
              	
817A:         	DIVDivideMod16:
              	
817A: C5      		push 	bc
817B: 42      		ld 		b,d 				; DE 
817C: 4B      		ld 		c,e
817D: EB      		ex 		de,hl
817E: 210000  		ld 		hl,0
8181: 78      		ld 		a,b
8182: 0608    		ld 		b,8
8184:         	Div16_Loop1:
8184: 17      		rla
8185: ED6A    		adc 	hl,hl
8187: ED52    		sbc 	hl,de
8189: 3001    		jr 		nc,Div16_NoAdd1
818B: 19      		add 	hl,de
818C:         	Div16_NoAdd1:
818C: 10F6    		djnz 	Div16_Loop1
818E: 17      		rla
818F: 2F      		cpl
8190: 47      		ld 		b,a
8191: 79      		ld 		a,c
8192: 48      		ld 		c,b
8193: 0608    		ld 		b,8
8195:         	Div16_Loop2:
8195: 17      		rla
8196: ED6A    		adc 	hl,hl
8198: ED52    		sbc 	hl,de
819A: 3001    		jr 		nc,Div16_NoAdd2
819C: 19      		add 	hl,de
819D:         	Div16_NoAdd2:
819D: 10F6    		djnz 	Div16_Loop2
819F: 17      		rla
81A0: 2F      		cpl
81A1: 51      		ld 		d,c
81A2: 5F      		ld 		e,a
81A3: C1      		pop 	bc
81A4: C9      		ret
              			
              			
              			include "support/farmemory.asm" 			; far memory routines
              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		farmemory.asm
              	;		Author :	paul@robsons.org.uk
              	;		Date : 		12th December 2018
              	;		Purpose :	Kernel - Far memory routines.
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              		
              	; ***********************************************************************************************
              	;
              	;								Byte compile far memory A/L
              	;
              	; ***********************************************************************************************
              	
81A5:         	FARCompileByte:
81A5: F5      			push 	af 									; save byte and HL
81A6: E5      			push 	hl
81A7: F5      			push 	af 									; save byte
81A8: 3AE58B  			ld		a,(HerePage) 						; switch to page
81AB: CD6083  			call 	PAGESwitch
81AE: 2AE38B  			ld 		hl,(Here) 							; write to memory location
81B1: F1      			pop 	af
81B2: 77      			ld 		(hl),a
81B3: 23      			inc 	hl 									; bump memory location
81B4: 22E38B  			ld 		(Here),hl 							; write back
81B7: CD7983  			call 	PAGERestore
81BA: E1      			pop 	hl 									; restore and exit
81BB: F1      			pop 	af
81BC: C9      			ret
              	
              	; ***********************************************************************************************
              	;
              	;								Word compile far memory A/HL
              	;
              	; ***********************************************************************************************
              	
81BD:         	FARCompileWord:
81BD: F5      			push 	af 									; save byte and HL
81BE: D5      			push 	de
81BF: E5      			push 	hl
81C0: EB      			ex 		de,hl 								; word into DE
81C1: 3AE58B  			ld		a,(HerePage) 						; switch to page
81C4: CD6083  			call 	PAGESwitch
81C7: 2AE38B  			ld 		hl,(Here) 							; write to memory location
81CA: 73      			ld 		(hl),e
81CB: 23      			inc 	hl 	
81CC: 72      			ld 		(hl),d
81CD: 23      			inc 	hl
81CE: 22E38B  			ld 		(Here),hl 							; write back
81D1: CD7983  			call 	PAGERestore
81D4: E1      			pop 	hl
81D5: D1      			pop 	de 									; restore and exit
81D6: F1      			pop 	af
81D7: C9      			ret
              			include "support/graphics.asm" 				; common graphics
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		graphics.asm
              	;		Purpose:	General screen I/O routines
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              	
              	; *********************************************************************************
              	;
              	;									Clear screen
              	;
              	; *********************************************************************************
              	
81D8:         	GFXClearScreen:
81D8: E5      			push 	hl 									; clear screen by reinitialising
81D9: 3AFF8B  			ld 		a,(__DIScreenMode)
81DC: CDE281  			call 	GFXMode
81DF: E1      			pop 	hl
81E0: C9      			ret
              	
              	; *********************************************************************************
              	;
              	;								Set Graphics Mode to A
              	;
              	; *********************************************************************************
              	
81E1:         	GFXModeE:
81E1: 7B      			ld 		a,e
81E2:         	GFXMode:
81E2: C5      			push 	bc
81E3: D5      			push 	de
81E4: E5      			push 	hl
81E5: 6F      			ld 		l,a 								; save current mode
81E6: 32FF8B  			ld 		(__DIScreenMode),a
81E9: 2D      			dec 	l 									; L = 1 mode layer2
81EA: 2808    			jr 		z,__GFXLayer2
81EC: 2D      			dec 	l
81ED: 280A    			jr 		z,__GFXLowRes 						; L = 2 mode lowres
              	
81EF: CD8F83  			call 	GFXInitialise48k					; L = 0 or anything else, 48k mode.
81F2: 1808    			jr 		__GFXConfigure
              	
81F4:         	__GFXLayer2:
81F4: CDF283  			call 	GFXInitialiseLayer2
81F7: 1803    			jr 		__GFXConfigure
              	
81F9:         	__GFXLowRes:
81F9: CD9E84  			call 	GFXInitialiseLowRes
              	
81FC:         	__GFXConfigure:
81FC: 7D      			ld 		a,l 								; save screen extent
81FD: 32F38B  			ld 		(__DIScreenWidth),a
8200: 7C      			ld 		a,h
8201: 32F78B  			ld 		(__DIScreenHeight),a
8204: EB      			ex 		de,hl 								; save driver
8205: 22058C  			ld 		(__DIScreenDriver),hl
8208: 6A      			ld 		l,d 								; make sizes 16 bit in HL/DE
8209: 2600    			ld 		h,0
820B: 1600    			ld 		d,0
820D: CD6081  			call 	MULTMultiply16
8210: 22FB8B  			ld 		(__DIScreenSize),hl
8213: E1      			pop 	hl
8214: D1      			pop 	de
8215: C1      			pop 	bc
8216: C9      			ret
              	
              	; *********************************************************************************
              	;
              	;		Write character D (colour) E (character) to position HL.
              	;
              	; *********************************************************************************
              	
8217:         	GFXWriteCharacter:
8217: F5      			push 	af
8218: C5      			push 	bc
8219: D5      			push 	de
821A: E5      			push 	hl
821B: 012582  			ld 		bc,__GFXWCExit
821E: C5      			push 	bc
821F: ED4B058C			ld 		bc,(__DIScreenDriver)
8223: C5      			push 	bc
8224: C9      			ret
8225:         	__GFXWCExit:
8225: E1      			pop 	hl
8226: D1      			pop 	de
8227: C1      			pop 	bc
8228: F1      			pop 	af
8229: C9      			ret
              	
              	; *********************************************************************************
              	;
              	;						Write hex word DE at position HL
              	;
              	; *********************************************************************************
              	
822A:         	GFXWriteHexWord:
822A: 3E06    			ld 		a,6 
822C:         	GFXWriteHexWordA:
822C: C5      			push 	bc
822D: D5      			push 	de
822E: E5      			push 	hl
822F: 4F      			ld 		c,a
8230: 7A      			ld 		a,d
8231: D5      			push 	de
8232: CD3E82  			call 	__GFXWHByte
8235: D1      			pop 	de
8236: 7B      			ld 		a,e
8237: CD3E82  			call	__GFXWHByte
823A: E1      			pop 	hl
823B: D1      			pop 	de
823C: C1      			pop 	bc
823D: C9      			ret
              	
823E:         	__GFXWHByte:
823E: F5      			push 	af
823F: CB0F    			rrc 	a
8241: CB0F    			rrc		a
8243: CB0F    			rrc 	a
8245: CB0F    			rrc 	a
8247: CD4B82  			call 	__GFXWHNibble
824A: F1      			pop 	af
824B:         	__GFXWHNibble:
824B: 51      			ld 		d,c
824C: E60F    			and 	15
824E: FE0A    			cp 		10
8250: 3802    			jr 		c,__GFXWHDigit
8252: C607    			add		a,7
8254:         	__GFXWHDigit:
8254: C630    			add 	a,48
8256: 5F      			ld 		e,a
8257: CD1782  			call 	GFXWriteCharacter
825A: 23      			inc 	hl
825B: C9      			ret
              	
              	; *********************************************************************************
              	;
              	;				For character A, put address of character in DE
              	;
              	; *********************************************************************************
              	
825C:         	GFXGetFontGraphicDE:
825C: F5      			push 	af
825D: C5      			push 	bc
825E: E5      			push 	hl
825F: E67F    			and 	$7F 								; bits 0-6 only.
8261: D620    			sub 	32
8263: 6F      			ld 		l,a 								; put in HL
8264: 2600    			ld 		h,0
8266: 29      			add 	hl,hl 								; x 8
8267: 29      			add 	hl,hl
8268: 29      			add 	hl,hl
8269: ED5B038C			ld 		de,(__DIFontBase) 					; add the font base.
826D: 19      			add 	hl,de
826E: EB      			ex 		de,hl 								; put in DE (font address)
826F: E1      			pop 	hl
8270: C1      			pop 	bc
8271: F1      			pop 	af
8272: FE7F    			cp 		$7F
8274: C0      			ret 	nz
8275: 117982  			ld 		de,__GFXPromptCharacter
8278: C9      			ret
              	
8279:         	__GFXPromptCharacter:
8279: FC7E3F1F			db 		$FC,$7E,$3F,$1F
827D: 1F3F7EFC			db 		$1F,$3F,$7E,$FC
              	
              	
              			include "support/keyboard.asm"				; keyboard handler
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		keyboard.asm
              	;		Purpose:	Spectrum Keyboard Interface
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              		
              	; *********************************************************************************
              	;
              	;			Scan the keyboard, return currently pressed key code in A
              	;
              	; *********************************************************************************
              		
8281:         	IOScanKeyboard:
8281: C5      			push 	bc
8282: D5      			push 	de
8283: E5      			push 	hl
              	
8284: 21D682  			ld 		hl,__kr_no_shift_table 				; firstly identify shift state.
              	
8287: 0EFE    			ld 		c,$FE 								; check CAPS SHIFT (emulator : left shift)
8289: 06FE    			ld 		b,$FE
828B: ED78    			in 		a,(c)
828D: CB47    			bit 	0,a
828F: 2005    			jr 		nz,__kr1
8291: 21FE82  			ld 		hl,__kr_shift_table
8294: 180B    			jr 		__kr2
8296:         	__kr1:
8296: 067F    			ld 		b,$7F 								; check SYMBOL SHIFT (emulator : right shift)
8298: ED78    			in 		a,(c)
829A: CB4F    			bit 	1,a
829C: 2003    			jr 		nz,__kr2
829E: 21FE82  			ld 		hl,__kr_symbol_shift_table
82A1:         	__kr2:
              	
82A1: 1EFE    			ld 		e,$FE 								; scan pattern.
82A3: 7B      	__kr3:	ld 		a,e 								; work out the mask, so we don't detect shift keys
82A4: 161E    			ld 		d,$1E 								; $FE row, don't check the least significant bit.
82A6: FEFE    			cp 		$FE
82A8: 2808    			jr 		z,___kr4
82AA: 161D    			ld 		d,$01D 								; $7F row, don't check the 2nd least significant bit
82AC: FE7F    			cp 		$7F
82AE: 2802    			jr 		z,___kr4
82B0: 161F    			ld 		d,$01F 								; check all bits.
82B2:         	___kr4:
82B2: 43      			ld 		b,e 								; scan the keyboard
82B3: 0EFE    			ld 		c,$FE
82B5: ED78    			in 		a,(c)
82B7: 2F      			cpl 										; make that active high.
82B8: A2      			and 	d  									; and with check value.
82B9: 2011    			jr 		nz,__kr_keypressed 					; exit loop if key pressed.
              	
82BB: 23      			inc 	hl 									; next set of keyboard characters
82BC: 23      			inc 	hl
82BD: 23      			inc 	hl
82BE: 23      			inc 	hl
82BF: 23      			inc 	hl
              	
82C0: 7B      			ld 		a,e 								; get pattern
82C1: 87      			add 	a,a 								; shift left
82C2: F601    			or 		1 									; set bit 1.
82C4: 5F      			ld 		e,a
              	
82C5: FEFF    			cp 		$FF 								; finished when all 1's.
82C7: 20DA    			jr 		nz,__kr3 
82C9: AF      			xor 	a
82CA: 1806    			jr 		__kr_exit 							; no key found, return with zero.
              	;
82CC:         	__kr_keypressed:
82CC: 23      			inc 	hl  								; shift right until carry set
82CD: 1F      			rra
82CE: 30FC    			jr 		nc,__kr_keypressed
82D0: 2B      			dec 	hl 									; undo the last inc hl
82D1: 7E      			ld 		a,(hl) 								; get the character number.
82D2:         	__kr_exit:
82D2: E1      			pop 	hl
82D3: D1      			pop 	de
82D4: C1      			pop 	bc
82D5: C9      			ret
              	
              	; *********************************************************************************
              	;	 						Keyboard Mapping Tables
              	; *********************************************************************************
              	;
              	;	$FEFE-$7FFE scan, bit 0-4, active low
              	;
              	;	3:Abort (Shift+Q) 8:Backspace 13:Return 
              	;	27:Break 32-127: Std ASCII all L/C
              	;
82D6:         	__kr_no_shift_table:
82D6: 007A7863			db 		0,  'z','x','c','v',			'a','s','d','f','g'
82DA: 76617364	
82DE: 6667    	
82E0: 71776572			db 		'q','w','e','r','t',			'1','2','3','4','5'
82E4: 74313233	
82E8: 3435    	
82EA: 30393837			db 		'0','9','8','7','6',			'p','o','i','u','y'
82EE: 36706F69	
82F2: 7579    	
82F4: 0D6C6B6A			db 		13, 'l','k','j','h',			' ', 0, 'm','n','b'
82F8: 6820006D	
82FC: 6E62    	
              	
82FE:         	__kr_shift_table:
82FE:         	__kr_symbol_shift_table:
82FE: 003A003F			db 		 0, ':', 0,  '?','/',			'~','|','\','{','}'
8302: 2F7E7C5C	
8306: 7B7D    	
8308: 0300003C			db 		 3,  0,  0  ,'<','>',			'!','@','#','$','%'
830C: 3E214023	
8310: 2425    	
8312: 5F292827			db 		'_',')','(',"'",'&',			'"',';', 0, ']','['
8316: 26223B00	
831A: 5D5B    	
831C: 1B3D2B2D			db 		27, '=','+','-','^',			' ', 0, '.',',','*'
8320: 5E20002E	
8324: 2C2A    	
              	
8326: 003A003F			db 		0,  ':',0  ,'?','/',			'~','|','\','{','}'
832A: 2F7E7C5C	
832E: 7B7D    	
8330: 0300003C			db 		3,  0,  0  ,'<','>',			16,17,18,19,20
8334: 3E101112	
8338: 1314    	
833A: 08291716			db 		8, ')',23,  22, 21,				'"',';', 0, ']','['
833E: 15223B00	
8342: 5D5B    	
8344: 1B3D2B2D			db 		27, '=','+','-','^',			' ', 0, '.',',','*'
8348: 5E20002E	
834C: 2C2A    	
              			include "support/paging.asm" 				; page switcher (not while executing)
              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		paging.asm
              	;		Author :	paul@robsons.org.uk
              	;		Date : 		12th December 2018
              	;		Purpose :	Paging Manager
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              	
              	; ********************************************************************************************************
              	;
              	; 									Initialise Paging, set current to A
              	;
              	; ********************************************************************************************************
              	
834E:         	PAGEInitialise:
834E: E5      			push 	hl
834F: ED9256  			db 		$ED,$92,$56							; switch to page A
8352: 3C      			inc 	a
8353: ED9257  			db 		$ED,$92,$57
8356: 3D      			dec 	a
8357: 08      			ex 		af,af' 								; put page in A'
8358: 210F8C  			ld 		hl,__PAGEStackBase 					; reset the page stack
835B: 220D8C  			ld 		(__PAGEStackPointer),hl
835E: E1      			pop 	hl
835F: C9      			ret
              	
              	; ********************************************************************************************************
              	;
              	;										Switch to a new page A
              	;
              	; ********************************************************************************************************
              	
8360:         	PAGESwitch:
8360: F5      			push 	af
8361: E5      			push 	hl
              	
8362: F5      			push 	af 									; save A on stack
8363: 2A0D8C  			ld 		hl,(__PAGEStackPointer) 			; put A' on the stack, the current page
8366: 08      			ex 		af,af'
8367: 77      			ld 		(hl),a
8368: 23      			inc 	hl
8369: 220D8C  			ld 		(__PAGEStackPointer),hl
              	
836C: F1      			pop 	af 									; restore new A
836D: ED9256  			db 		$ED,$92,$56							; switch to page A
8370: 3C      			inc 	a
8371: ED9257  			db 		$ED,$92,$57
8374: 3D      			dec 	a
8375: 08      			ex 		af,af' 								; put page in A'
              	
8376: E1      			pop 	hl
8377: F1      			pop 	af
8378: C9      			ret
              	
              	; ********************************************************************************************************
              	;
              	;										Return to the previous page
              	;
              	; ********************************************************************************************************
              	
8379:         	PAGERestore:
8379: F5      			push 	af
837A: E5      			push 	hl
837B: 2A0D8C  			ld 		hl,(__PAGEStackPointer) 			; pop the old page off
837E: 2B      			dec 	hl
837F: 7E      			ld 		a,(hl)
8380: 220D8C  			ld 		(__PAGEStackPointer),hl
8383: ED9256  			db 		$ED,$92,$56							; switch to page A
8386: 3C      			inc 	a
8387: ED9257  			db 		$ED,$92,$57
838A: 3D      			dec 	a
838B: 08      			ex 		af,af' 								; update A'
838C: E1      			pop 	hl
838D: F1      			pop 	af
838E: C9      			ret
              					
              			include "support/screen48k.asm"				; screen "drivers"
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		screen48k.asm
              	;		Purpose:	Hardware interface to Spectrum display, standard but with
              	;					sprites enabled. 	
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              	
              	; *********************************************************************************
              	;
              	;						Call the SetMode for the Spectrum 48k 
              	;
              	; *********************************************************************************
              	
838F:         	GFXInitialise48k:
838F: F5      			push 	af 									; save registers
8390: C5      			push 	bc
              	
8391: 013B12  			ld 		bc,$123B 							; Layer 2 access port
8394: 3E00    			ld 		a,0 								; disable Layer 2
8396: ED79    			out 	(c),a
8398: ED911503			db 		$ED,$91,$15,$3						; Disable LowRes but enable Sprites
              	
839C: 210040  			ld 		hl,$4000 							; clear pixel memory
839F: 3600    	__cs1:	ld 		(hl),0
83A1: 23      			inc 	hl
83A2: 7C      			ld 		a,h
83A3: FE58    			cp 		$58
83A5: 20F8    			jr 		nz,__cs1
83A7: 3647    	__cs2:	ld 		(hl),$47							; clear attribute memory
83A9: 23      			inc 	hl
83AA: 7C      			ld 		a,h
83AB: FE5B    			cp 		$5B
83AD: 20F8    			jr 		nz,__cs2	
83AF: AF      			xor 	a 									; border off
83B0: D3FE    			out 	($FE),a
83B2: C1      			pop 	bc
83B3: F1      			pop 	af
83B4: 212018  			ld 		hl,$1820 							; H = 24,L = 32, screen extent
83B7: 11BB83  			ld 		de,GFXPrintCharacter48k
83BA: C9      			ret
              	
              	; *********************************************************************************
              	;
              	;				Write a character E on the screen at HL, in colour D
              	;
              	; *********************************************************************************
              	
83BB:         	GFXPrintCharacter48k:
83BB: F5      			push 	af 									; save registers
83BC: C5      			push 	bc
83BD: D5      			push 	de
83BE: E5      			push 	hl
              	
83BF: 43      			ld 		b,e 								; character in B
83C0: 7C      			ld 		a,h 								; check range.
83C1: FE03    			cp 		3
83C3: 3028    			jr 		nc,__ZXWCExit
              	;
              	;		work out attribute position
              	;
83C5: E5      			push 	hl 									; save position.
83C6: 7C      			ld 		a,h
83C7: C658    			add 	$58
83C9: 67      			ld 		h,a
              	
83CA: 7A      			ld 		a,d 								; get current colour
83CB: E607    			and 	7  									; mask 0..2
83CD: F640    			or 		$40  								; make bright
83CF: 77      			ld 		(hl),a 								; store it.	
83D0: E1      			pop 	hl
              	;
              	;		calculate screen position => HL
              	;
83D1: D5      			push 	de
83D2: EB      			ex 		de,hl
83D3: 6B      			ld 		l,e 								; Y5 Y4 Y3 X4 X3 X2 X1 X0
83D4: 7A      			ld 		a,d
83D5: E603    			and 	3
83D7: 87      			add 	a,a
83D8: 87      			add 	a,a
83D9: 87      			add 	a,a
83DA: F640    			or 		$40
83DC: 67      			ld 		h,a
83DD: D1      			pop 	de
              	;
              	;		char# 32-127 to font address => DE
              	;
83DE: 78      			ld 		a,b 								; get character
83DF: CD5C82  			call 	GFXGetFontGraphicDE
              	;
              	;		copy font data to screen position.
              	;
83E2: 78      			ld 		a,b
83E3: 0608    			ld 		b,8 								; copy 8 characters
83E5: 0E00    			ld 		c,0 								; XOR value 0
83E7:         	__ZXWCCopy:
83E7: 1A      			ld 		a,(de)								; get font data
83E8: 77      			ld 		(hl),a 								; write back
83E9: 24      			inc 	h 									; bump pointers
83EA: 13      			inc 	de
83EB: 10FA    			djnz 	__ZXWCCopy 							; do B times.
83ED:         	__ZXWCExit:
83ED: E1      			pop 	hl 									; restore and exit
83EE: D1      			pop 	de
83EF: C1      			pop 	bc
83F0: F1      			pop 	af
83F1: C9      			ret
              	
              			include "support/screen_layer2.asm"
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		screen_layer2.asm
              	;		Purpose:	Layer 2 console interface, sprites enabled, no shadow.
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              	
              	; *********************************************************************************
              	;
              	;								Clear Layer 2 Display.
              	;
              	; *********************************************************************************
              	
              	
83F2:         	GFXInitialiseLayer2:
83F2: F5      			push 	af
83F3: C5      			push 	bc
83F4: D5      			push 	de
83F5: ED911503			db 		$ED,$91,$15,$3						; Disable LowRes but enable Sprites
              	
83F9: 1E02    			ld 		e,2 								; 3 banks to erase
83FB:         	L2PClear:
83FB: 7B      			ld 		a,e 								; put bank number in bits 6/7
83FC: CB0F    			rrc 	a
83FE: CB0F    			rrc 	a
8400: F603    			or 		2+1 								; shadow on, visible, enable write paging
8402: 013B12  			ld 		bc,$123B 							; out to layer 2 port
8405: ED79    			out 	(c),a
8407: 210040  			ld 		hl,$4000 							; erase the bank to $00 
840A: 55      			ld 		d,l 								; D = 0, slightly quicker.
840B:         	L2PClearBank: 										; assume default palette :)
840B: 2B      			dec 	hl
840C: 72      			ld 		(hl),d
840D: 7C      			ld 		a,h
840E: B5      			or 		l
840F: 20FA    			jr		nz,L2PClearBank
8411: 1D      			dec 	e
8412: F2FB83  			jp 		p,L2PClear
              	
8415: AF      			xor 	a
8416: D3FE    			out 	($FE),a
              	
8418: D1      			pop 	de
8419: C1      			pop 	bc
841A: F1      			pop 	af
841B: 212018  			ld 		hl,$1820 							; still 32 x 24 	
841E: 112284  			ld 		de,GFXPrintCharacterLayer2
8421: C9      			ret
              	;
              	;		Print Character E, colour D, position HL
              	;
8422:         	GFXPrintCharacterLayer2:
8422: F5      			push 	af
8423: C5      			push 	bc
8424: D5      			push 	de
8425: E5      			push 	hl
8426: DDE5    			push 	ix
              	
8428: 43      			ld 		b,e 								; save A temporarily
8429: 78      			ld 		a,b
              	
842A: 7C      			ld 		a,h
842B: FE03    			cp 		3
842D: 3068    			jr 		nc,__L2Exit 						; check position in range
842F: 78      			ld 		a,b
              	
8430: F5      			push 	af 	
8431: AF      			xor 	a 									; convert colour in C to palette index
8432: CB42    			bit 	0,d 								; (assumes standard palette)
8434: 2802    			jr 		z,__L2Not1
8436: F603    			or 		$03
8438:         	__L2Not1:
8438: CB52    			bit 	2,d
843A: 2802    			jr 		z,__L2Not2
843C: F61C    			or 		$1C
843E:         	__L2Not2:
843E: CB4A    			bit 	1,d
8440: 2802    			jr 		z,__L2Not3
8442: F6C0    			or 		$C0
8444:         	__L2Not3:
8444: 4F      			ld 		c,a 								; C is foreground
8445: F1      			pop 	af 									; restore char
              	
8446: CD5C82  			call 	GFXGetFontGraphicDE 				; font offset in DE
8449: D5      			push 	de 									; transfer to IX
844A: DDE1    			pop 	ix
              	
              			;
              			;		figure out the correct bank.
              			;
844C: C5      			push 	bc
844D: 7C      			ld  	a,h 								; this is the page number.
844E: CB0F    			rrc 	a
8450: CB0F    			rrc 	a
8452: E6C0    			and 	$C0 								; in bits 6 & 7
8454: F603    			or 		$03 								; shadow on, visible, enable write pagin.
8456: 013B12  			ld 		bc,$123B 							; out to layer 2 port
8459: ED79    			out 	(c),a
845B: C1      			pop 	bc
              			;
              			; 		now figure out position in bank
              			;
845C: EB      			ex 		de,hl
845D: 6B      			ld 		l,e
845E: 2600    			ld 		h,0
8460: 29      			add 	hl,hl 								
8461: 29      			add 	hl,hl
8462: 29      			add 	hl,hl
8463: CB24    			sla 	h
8465: CB24    			sla 	h
8467: CB24    			sla 	h
              	
8469: 1E08    			ld 		e,8 								; do 8 rows
846B:         	__L2Outer:
846B: E5      			push 	hl 									; save start
846C: 1608    			ld 		d,8 								; do 8 columns
846E: DD7E00  			ld 		a,(ix+0) 							; get the bit pattern
8471: DD23    			inc 	ix
8473: B7      			or 		a
8474: 280C    			jr 		z,__L2Blank
8476:         	__L2Loop:
8476: 3600    			ld 		(hl),0 								; background
8478: 87      			add 	a,a 								; shift pattern left
8479: 3001    			jr 		nc,__L2NotSet
847B: 71      			ld 		(hl),c 								; if MSB was set, overwrite with fgr
847C:         	__L2NotSet:
847C: 23      			inc 	hl
847D: 15      			dec 	d 									; do a row
847E: 20F6    			jr 		nz,	__L2Loop
8480: 1810    			jr 		__L2Exit1
8482:         	__L2Blank:
8482: AF      			xor 	a
8483: 77      			ld 		(hl),a
8484: 23      			inc 	hl
8485: 77      			ld 		(hl),a
8486: 23      			inc 	hl
8487: 77      			ld 		(hl),a
8488: 23      			inc 	hl
8489: 77      			ld 		(hl),a
848A: 23      			inc 	hl
848B: 77      			ld 		(hl),a
848C: 23      			inc 	hl
848D: 77      			ld 		(hl),a
848E: 23      			inc 	hl
848F: 77      			ld 		(hl),a
8490: 23      			inc 	hl
8491: 77      			ld 		(hl),a
8492:         	__L2Exit1:
8492: E1      			pop 	hl 									; restore, go 256 bytes down.
8493: 24      			inc 	h
8494: 1D      			dec 	e 									; do 8 rows
8495: 20D4    			jr 		nz,__L2Outer	
8497:         	__L2Exit:
8497: DDE1    			pop 	ix
8499: E1      			pop 	hl
849A: D1      			pop 	de
849B: C1      			pop 	bc
849C: F1      			pop 	af
849D: C9      			ret
              			include "support/screen_lores.asm"
              	; *********************************************************************************
              	; *********************************************************************************
              	;
              	;		File:		screen_lores.asm
              	;		Purpose:	LowRes console interface, sprites enabled.
              	;		Date : 		12th December 2018
              	;		Author:		paul@robsons.org.uk
              	;
              	; *********************************************************************************
              	; *********************************************************************************
              	
              	; *********************************************************************************
              	;
              	;								Clear LowRes Display.
              	;
              	; *********************************************************************************
              	
849E:         	GFXInitialiseLowRes:
849E: F5      			push 	af
849F: C5      			push 	bc
84A0: D5      			push 	de
              	
84A1: ED911583			db 		$ED,$91,$15,$83						; Enable LowRes and enable Sprites
84A5: AF      			xor 	a 									; layer 2 off.
84A6: 013B12  			ld 		bc,$123B 							; out to layer 2 port
84A9: ED79    			out 	(c),a
              	
84AB: 210040  			ld 		hl,$4000 							; erase the bank to $00 
84AE: 110060  			ld 		de,$6000
84B1:         	LowClearScreen: 									; assume default palette :)
84B1: AF      			xor 	a
84B2: 77      			ld 		(hl),a
84B3: 12      			ld 		(de),a
84B4: 23      			inc 	hl
84B5: 13      			inc 	de
84B6: 7C      			ld 		a,h
84B7: FE58    			cp 		$58
84B9: 20F6    			jr		nz,LowClearScreen
84BB: AF      			xor 	a
84BC: D3FE    			out 	($FE),a
84BE: D1      			pop 	de
84BF: C1      			pop 	bc
84C0: F1      			pop 	af
84C1: 21100C  			ld 		hl,$0C10 							; resolution is 16x12 chars
84C4: 11C884  			ld 		de,GFXPrintCharacterLowRes
84C7: C9      			ret
              	;
              	;		Print Character E Colour D @ HL
              	;
84C8:         	GFXPrintCharacterLowRes:
84C8: F5      			push 	af
84C9: C5      			push 	bc
84CA: D5      			push 	de
84CB: E5      			push 	hl
84CC: DDE5    			push 	ix
              	
84CE: 43      			ld 		b,e 								; save character in B
              	
84CF: 29      			add 	hl,hl
84D0: 29      			add 	hl,hl
84D1: 7C      			ld	 	a,h 								; check in range 192*4 = 768
84D2: FE03    			cp 		3
84D4: 3046    			jr 		nc,__LPExit
              	
84D6: 7A      			ld 		a,d 								; only lower 3 bits of colour
84D7: E607    			and 	7
84D9: 4F      			ld 		c,a 								; C is foreground
              	
84DA: 78      			ld 		a,b 								; get char back
84DB: CD5C82  			call 	GFXGetFontGraphicDE
84DE: D5      			push 	de
84DF: DDE1    			pop 	ix
              	
84E1: EB      			ex 		de,hl
84E2: 7B      			ld 		a,e 								; put DE => HL
84E3: E6C0    			and 	192 								; these are part of Y
84E5: 6F      			ld 		l,a  								; Y multiplied by 4 then 32 = 128
84E6: 62      			ld 		h,d		
84E7: 29      			add 	hl,hl
84E8: 29      			add 	hl,hl
84E9: 29      			add 	hl,hl
84EA: 29      			add 	hl,hl
84EB: CBF4    			set 	6,h 								; put into $4000 range
              	
84ED: 3E3C    			ld 		a,15*4 								; mask for X, which has been premultiplied.
84EF: A3      			and 	e 									; and with E, gives X position
84F0: 87      			add 	a,a 								; now multiplied by 8.
84F1: 5F      			ld 		e,a 								; DE is x offset.
84F2: 1600    			ld 		d,0  
              	
84F4: 19      			add 	hl,de
84F5: 7C      			ld 		a,h
84F6: FE58    			cp 		$58 								; need to be shifted to 2nd chunk ?
84F8: 3804    			jr 		c,__LowNotLower2
84FA: 110008  			ld 		de,$0800
84FD: 19      			add 	hl,de
84FE:         	__LowNotLower2:
84FE: 1E08    			ld 		e,8 								; do 8 rows
8500:         	__LowOuter:
8500: E5      			push 	hl 									; save start
8501: 1608    			ld 		d,8 								; do 8 columns
8503: DD7E00  			ld 		a,(ix+0) 							; get the bit pattern
8506: DD23    			inc 	ix
8508:         	__LowLoop:
8508: 3600    			ld 		(hl),0 								; background
850A: 87      			add 	a,a 								; shift pattern left
850B: 3001    			jr 		nc,__LowNotSet
850D: 71      			ld 		(hl),c 								; if MSB was set, overwrite with fgr
850E:         	__LowNotSet:
850E: 2C      			inc 	l
850F: 15      			dec 	d 									; do a row
8510: 20F6    			jr 		nz,	__LowLoop
8512: E1      			pop 	hl 									; restore, go 256 bytes down.
8513: D5      			push 	de
8514: 118000  			ld 		de,128
8517: 19      			add 	hl,de
8518: D1      			pop 	de
8519: 1D      			dec 	e 									; do 8 rows
851A: 20E4    			jr 		nz,__LowOuter	
851C:         	__LPExit:
851C: DDE1    			pop 	ix
851E: E1      			pop 	hl
851F: D1      			pop 	de
8520: C1      			pop 	bc
8521: F1      			pop 	af
8522: C9      			ret
              	
              	
              			include "compiler/buffer.asm" 				; buffer code.
              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		buffer.asm
              	;		Author :	Paul Robson (paul@robsons.org.uk)
              	;		Date : 		12th December 2018
              	;		Purpose :	Scan pages for buffers.
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              	
              	; ***************************************************************************************
              	;
              	;						Scan and compile all pages with buffers
              	;
              	; ***************************************************************************************
              	
8523:         	BUFFScan:
8523: 2101AA  			ld 		hl,$AA01	 						; setup A and B
8526: 1102BB  			ld 		de,$BB02
8529: 210000  			ld 		hl,$0000
852C: 110000  			ld 		de,$0000
852F: 22078C  			ld 		(__ARegister),hl
8532: ED53098C			ld 		(__BRegister),de
8536: 1E22    			ld 		e,FirstSourcePage 					; set the first source page.
              	;
              	;		Loop here to scan the next source page.
              	;
8538:         	__BUFFScanSourcePage:
8538: 7B      			ld 		a,e 								; switch to the source page.
8539: CD6083  			call 	PAGESwitch
853C: DD2100C0			ld 		ix,$C000 							; next page to scan.
              	;
              	;		Come here to scan the buffer at E:HL
              	;
8540:         	__BUFFScanNextPageInBuffer:
8540: DD7E00  			ld 		a,(ix+0) 							; is the buffer empty ?
8543: FE80    			cp 		$80
8545: 2821    			jr 		z,__BUFFNextPage 					; don't bother with this whole page.
              	
8547: D5      			push 	de 									; save E
              	
8548: DDE5    			push 	ix									; copy into edit buffer.
854A: E1      			pop 	hl
854B: 11087B  			ld 		de,EditBuffer
854E: 010002  			ld 		bc,EditPageSize
8551: EDB0    			ldir 
              	
8553: 01087B  			ld 		bc,EditBuffer 						; BC is the code to compile.
8556: 2A078C  			ld 		hl,(__ARegister)					; load registers
8559: ED5B098C			ld 		de,(__BRegister)
855D: CDAF86  			call 	COMCompileWordList 					; compile that word list.
8560: ED53098C			ld 		(__BRegister),de
8564: 22078C  			ld 		(__ARegister),hl
8567: D1      			pop 	de 									; restore E
              			
8568:         	__BUFFNextPage:		
8568: 010002  			ld 		bc,EditPageSize 					; go to next buffer
856B: DD09    			add 	ix,bc
856D: 30D1    			jr 		nc,__BUFFScanNextPageInBuffer
              	
856F: CD7983  			call 	PAGERestore 						; back to original page
              	
8572: 1C      			inc 	e 									; go forward 2 (using 16k pages)
8573: 1C      			inc 	e
8574: 7B      			ld 		a,e  								; check scanned all buffers.
8575: FE26    			cp 		FirstSourcePage+SourcePageCount 
8577: 20BF    			jr 		nz,__BUFFScanSourcePage
              	
8579: C31A80  			jp 		CommandLineStart
              	
              	
              			include "compiler/utility.asm"				; utility functions.
              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		utility.asm
              	;		Author :	Paul Robson (paul@robsons.org.uk)
              	;		Date : 		12th December 2018
              	;		Purpose :	Compile Utilities
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              	
              	; ***************************************************************************************
              	;
              	;								Compile call to E:HL
              	;
              	; ***************************************************************************************
              	
857C:         	COMUCompileCall:
              			;
              			;	TODO: Crosspage call if >= $C000 and page different
              			;
857C: 3ECD    			ld 		a,$CD 								; Z80 Call
857E: CDA581  			call 	FARCompileByte
8581: CDBD81  			call 	FARCompileWord						; compile address
8584: C9      			ret
              	
              	; ***************************************************************************************
              	;
              	;							Compile code to load constant
              	;
              	; ***************************************************************************************
              	
8585:         	COMUCompileConstant:
8585: 3EEB    			ld 		a,$EB 								; EX DE,HL
8587: CDA581  			call 	FARCompileByte
858A: 3E21    			ld 		a,$21								; LD HL,xxxx
858C: CDA581  			call 	FARCompileByte
858F: CDBD81  			call 	FARCompileWord						; compile constant
8592: C9      			ret
              	
              	; ***************************************************************************************
              	;
              	;			Compile code to copy A bytes from code following caller (for MACRO)
              	;
              	; ***************************************************************************************
              	
8593:         	COMUCopyCode:
8593: E3      			ex 		(sp),hl 							; old HL on stack, new HL is return address
8594: C5      			push 	bc 									; preserve BC
8595: 46      			ld 		b,(hl) 								; count to copy
8596:         	__COMUCopyLoop:
8596: 23      			inc 	hl
8597: 7E      			ld 		a,(hl) 								; read a byte
8598: CDA581  			call 	FARCompileByte 						; compile it
859B: 10F9    			djnz	__COMUCopyLoop
859D: C1      			pop 	bc 									; restore BC
859E: E1      			pop 	hl 									; restore old HL.
859F: C9      			ret
              	
              	
              	
              			include "compiler/constant.asm"				; ASCII -> Integer conversion
              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		constant.asm
              	;		Author :	Paul Robson (paul@robsons.org.uk)
              	;		Date : 		12th December 2018
              	;		Purpose :	ASCII -> Integer conversion.
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              	
              	; ***********************************************************************************************
              	;
              	;		Convert Tagged ASCII string at BC to constant in HL. Carry Clear if successful.
              	;								Uses Colorforth's backend - format.
              	;
              	; ***********************************************************************************************
              	
85A0:         	CONSTConvert:
85A0: C5      		push 	bc
              	
85A1: 50      		ld 		d,b 									; string in DE.
85A2: 59      		ld 		e,c
85A3: 13      		inc 	de 										; skip over the tag byte.
              	
85A4: 210000  		ld 		hl,$0000								; result in HL.
85A7:         	__CONConvLoop:
85A7: 1A      		ld 		a,(de)									; get next character
85A8: 13      		inc 	de
              	
85A9: FE30    		cp 		'0'										; must be 0-9 otherwise
85AB: 382D    		jr 		c,__CONConFail
85AD: FE3A    		cp 		'9'+1
85AF: 3029    		jr 		nc,__CONConFail
              	
85B1: C5      		push 	bc
85B2: E5      		push 	hl 										; HL -> BC
85B3: C1      		pop 	bc
85B4: 29      		add 	hl,hl 									; HL := HL * 4 + BC 
85B5: 29      		add 	hl,hl
85B6: 09      		add 	hl,bc 						
85B7: 29      		add 	hl,hl 									; HL := HL * 10
85B8: 0600    		ld 		b,0 									; add the digit into HL
85BA: E60F    		and 	15
85BC: 4F      		ld 		c,a
85BD: 09      		add 	hl,bc
85BE: C1      		pop 	bc
              	
85BF: 1A      		ld 		a,(de) 									; check ends in -
85C0: FE2D    		cp 		'-'									
85C2: 2806    		jr 		z,__CONMinusExit 						
85C4: CB7F    		bit 	7,a										; keep going till reached the next tag.
85C6: 28DF    		jr 		z,__CONConvLoop
85C8: 180D    		jr 		__CONNotNegative
              	
85CA:         	__CONMinusExit:
85CA: 13      		inc 	de 										; if not the last, it's an error.
85CB: 1A      		ld 		a,(de)
85CC: CB7F    		bit 	7,a
85CE: 280A    		jr		z,__CONConFail
              	
85D0: 7C      		ld 		a,h 									; negate HL
85D1: 2F      		cpl 	
85D2: 67      		ld 		h,a
85D3: 7D      		ld 		a,l
85D4: 2F      		cpl
85D5: 6F      		ld 		l,a
85D6: 23      		inc 	hl
              	
85D7:         	__CONNotNegative:
85D7: AF      		xor 	a 										; clear carry
85D8: C1      		pop 	bc
85D9: C9      		ret
              	
85DA:         	__CONConFail: 										; didn't convert
85DA: 37      		scf
85DB: C1      		pop 	bc
85DC: C9      		ret
              		
              			include "compiler/dictionary.asm" 			; Dictionary workers
              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		dictionary.asm
              	;		Author :	Paul Robson (paul@robsons.org.uk)
              	;		Date : 		12th December 2018
              	;		Purpose :	Dictionary handler.
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              	
              	; ***********************************************************************************************
              	;
              	;		Add Dictionary Word. Name is a tagged string at BC ends in $80-$FF, uses the current 
              	;		page/pointer values. 
              	;
              	; ***********************************************************************************************
              	
85DD:         	DICTAddWord:
85DD: F5      			push 	af 									; registers to stack.
85DE: C5      			push 	bc
85DF: D5      			push 	de
85E0: E5      			push	hl
85E1: DDE5    			push 	ix
              	
85E3: C5      			push 	bc 									; put word address in HL
85E4: E1      			pop 	hl 
              	
85E5: 7E      			ld 		a,(hl) 								; get length from tag into B
85E6: E61F    			and 	$1F
85E8: 47      			ld 		b,a
85E9: 23      			inc 	hl 									; HL = first character
              	
85EA: 3E20    			ld 		a,DictionaryPage					; switch to dictionary page
85EC: CD6083  			call 	PAGESwitch
              	
85EF: DD2100C0			ld 		ix,$C000							; IX = Start of dictionary
              	
85F3:         	__DICTFindEndDictionary:
85F3: DD7E00  			ld 		a,(ix+0) 							; follow down chain to the end
85F6: B7      			or 		a
85F7: 2807    			jr 		z,__DICTCreateEntry
85F9: 5F      			ld 		e,a
85FA: 1600    			ld 		d,0
85FC: DD19    			add 	ix,de
85FE: 18F3    			jr 		__DICTFindEndDictionary
              	
8600:         	__DICTCreateEntry:
8600: DD220B8C			ld 		(__DICTLastWordDefined),ix 			; set last word defined address
              	
8604: 78      			ld 		a,b
8605: C605    			add 	a,5
8607: DD7700  			ld 		(ix+0),a 							; offset is length + 5
              	
860A: 3AE58B  			ld 		a,(HerePage)						; code page
860D: DD7701  			ld 		(ix+1),a
              	
8610: ED5BE38B			ld 		de,(Here) 							; code address
8614: DD7302  			ld 		(ix+2),e
8617: DD7203  			ld 		(ix+3),d 
              	
861A: DD7004  			ld 		(ix+4),b 							; put length in.
              	
861D: EB      			ex 		de,hl 								; put name in DE
861E:         	__DICTAddCopy:
861E: 1A      			ld 		a,(de) 								; copy byte over as 7 bit ASCII.
861F: DD7705  			ld 		(ix+5),a
8622: DD23    			inc 	ix 									
8624: 13      			inc 	de
8625: 10F7    			djnz	__DICTAddCopy 						; until string is copied over.
              	
8627: DD360500			ld 		(ix+5),0 							; write end of dictionary zero.
              	
862B: CD7983  			call 	PAGERestore
862E: DDE1    			pop 	ix 									; restore and exit
8630: E1      			pop 	hl
8631: D1      	 		pop 	de
8632: C1      			pop 	bc
8633: F1      			pop 	af
8634: C9      			ret
              	
              	; ***********************************************************************************************
              	;
              	;									Make the last word "compiles"
              	;
              	; ***********************************************************************************************
              	
8635:         	DICTMakeLastCompiles:
8635: F5      			push 	af
8636: DDE5    			push 	ix
8638: 3E20    			ld 		a,DictionaryPage					; switch to dictionary page
863A: CD6083  			call 	PAGESwitch
863D: DD2A0B8C			ld 		ix,(__DICTLastWordDefined) 			; address of last defined word
8641: DDCB04FE			set 	7,(ix+4) 							; set bit 7 to make it 'commands'
8645: DDE1    			pop 	ix
8647: F1      			pop 	af
8648: C9      			ret
              	
              	; ***********************************************************************************************
              	;
              	;			Find word in dictionary. BC points to tagged string which is the name.
              	;			A is the flag to check if we are looking for compiles ($80) or normal ($00)
              	; 
              	;			On exit, HL is the address and E the page number with CC if found, 
              	;			CS set and HL=DE=0 if not found.
              	;
              	; ***********************************************************************************************
              	
8649:         	DICTFindWord:
8649: C5      			push 	bc 								; save registers - return in EHL Carry
864A: DDE5    			push 	ix
              	
864C: 60      			ld 		h,b 							; put address of name in HL. 
864D: 69      			ld 		l,c
864E: 4F      			ld 		c,a 							; save compiles flag check in C
864F: 3E20    			ld 		a,DictionaryPage 				; switch to dictionary page
8651: CD6083  			call 	PAGESwitch
              	
8654: DD2100C0			ld 		ix,$C000 						; dictionary start			
8658:         	__DICTFindMainLoop:
8658: DD7E00  			ld 		a,(ix+0)						; examine offset, exit if zero.
865B: B7      			or 		a
865C: 2841    			jr 		z,__DICTFindFail
              	
865E: DD7E04  			ld 		a,(ix+4) 						; length
8661: AE      			xor 	(hl) 							; xor with tag length
8662: E61F    			and 	$1F 							; check lower 5 bits
8664: 2030    			jr 		nz,__DICTFindNext 				; if different can't be this word.
              	
8666: DD7E04  			ld 		a,(ix+4) 						; are the sign bits of the length/type byte and 
8669: A9      			xor 	c  								; the search parameter the same.
866A: FA9686  			jp 		m,__DICTFindNext 				; if different, can't be this word.
              			
866D: DDE5    			push 	ix 								; save pointers on stack.
866F: E5      			push 	hl 
              	
8670: DD7E04  			ld 		a,(ix+4)						; get the word length to test into B
8673: E61F    			and 	$1F
8675: 47      			ld 		b,a 							; into B
8676: 23      			inc 	hl 								; skip over tag byte
8677:         	__DICTCheckName:
8677: DD7E05  			ld 		a,(ix+5) 						; compare dictionary vs character.
867A: BE      			cp 		(hl) 							; compare vs the matching character.
867B: 2016    			jr 		nz,__DICTFindNoMatch 			; no, not the same word.
867D: 23      			inc 	hl 								; HL point to next character
867E: DD23    			inc 	ix
8680: 10F5    			djnz 	__DICTCheckName
              	
8682: E1      			pop 	hl 								; Found a match. restore HL and IX
8683: DDE1    			pop 	ix
              		
8685: 1600    			ld 		d,0 							; D = 0 for neatness.
8687: DD5E01  			ld 		e,(ix+1)						; E = page
868A: DD6E02  			ld 		l,(ix+2)						; HL = address
868D: DD6603  			ld 		h,(ix+3)		
8690: AF      			xor 	a 								; clear the carry flag.
8691: 1813    			jr 		__DICTFindExit
              	
8693:         	__DICTFindNoMatch:								; this one doesn't match.
8693: E1      			pop 	hl 								; restore HL and IX
8694: DDE1    			pop 	ix
8696:         	__DICTFindNext:
8696: DD5E00  			ld 		e,(ix+0)						; DE = offset
8699: 1600    			ld 		d,$00
869B: DD19    			add 	ix,de 							; next word.
869D: 18B9    			jr 		__DICTFindMainLoop				; and try the next one.
              	
869F:         	__DICTFindFail:
869F: 110000  			ld 		de,$0000 						; return all zeros.
86A2: 210000  			ld 		hl,$0000
86A5: 37      			scf 									; set carry flag
86A6:         	__DICTFindExit:
86A6: F5      			push 	af
86A7: CD7983  			call 	PAGERestore
86AA: F1      			pop 	af
86AB: DDE1    			pop 	ix 								; pop registers and return.
86AD: C1      			pop 	bc
86AE: C9      			ret
              			include "compiler/compiler.asm"				; compiler
              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		compiler.asm
              	;		Author :	Paul Robson (paul@robsons.org.uk)
              	;		Date : 		12th December 2018
              	;		Purpose :	Compiles a list of word split by tags.
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              	
              	; ***************************************************************************************
              	;
              	;					Compile word list at BC. HLDE contain A/B
              	;
              	; ***************************************************************************************
              	
86AF:         	COMCompileWordList:
86AF: C5      			push 	bc 									; save non value registers (HLDE can change)
86B0: DDE5    			push 	ix
              	
86B2:         	__COMWLoop:
86B2: 0A      			ld 		a,(bc) 								; reached the end ?
86B3: FE80    			cp 		$80
86B5: 281E    			jr 		z,__COMWExit
              	
86B7: 0A      			ld 		a,(bc) 								; 1 00 lllll (Red)
86B8: E660    			and 	$60
86BA: CCDF86  			call 	z,COMDCompileRedWord 				
              	
86BD: 0A      			ld 		a,(bc) 								; 1 01 lllll (Green)
86BE: E660    			and 	$60
86C0: FE20    			cp 		$20
86C2: CCE386  			call 	z,COMCCompileGreenWord
              	
86C5: 0A      			ld 		a,(bc) 								; 1 10 lllll (Yellow)
86C6: E660    			and 	$60
86C8: FE40    			cp 		$40
86CA: CC0887  			call 	z,COMXExecuteYellowWord
              	
86CD:         	__COMWNext: 										; advance to next tag.
86CD: 03      			inc 	bc 
86CE: 0A      			ld 		a,(bc)
86CF: CB7F    			bit 	7,a
86D1: 28FA    			jr 		z,__COMWNext
86D3: 18DD    			jr 		__COMWLoop 							; go do that.
              			
86D5:         	__COMWExit: 										; exit the routine
86D5: DDE1    			pop 	ix
86D7: C1      			pop 	bc
86D8: C9      			ret
              	;
              	;		Jump here on error.
              	;
86D9:         	COMError:
86D9: C5      			push 	bc
86DA: E1      			pop 	hl
86DB: 23      			inc 	hl
86DC: C32880  			jp 		ErrorHandler
              	
              	
              	; ***************************************************************************************
              	;
              	;	 		Compiles a red word. Add to the currently selected dictionary
              	;
              	; ***************************************************************************************
              	
86DF:         	COMDCompileRedWord:
86DF: CDDD85  			call 	DICTAddWord 						; add word to the dictionary.
86E2: C9      			ret
              		
              	; ***************************************************************************************
              	;
              	;										Green word.
              	;
              	; ***************************************************************************************
              	
86E3:         	COMCCompileGreenWord:	
86E3: D5      			push 	de 									; save A & B
86E4: E5      			push 	hl
86E5: 3E80    			ld 		a,$80 								; check for "compiles" entries
86E7: CD4986  			call 	DICTFindWord
86EA: 302F    			jr 		nc,__COMXExecuteWord 				; if found execute it.
86EC: 3E00    			ld 		a,$00 								; check for normal entries
86EE: CD4986  			call 	DICTFindWord
86F1: 300F    			jr 		nc,__COMCCompile 					; if found, then compile it.
86F3: CD4986  			call 	DICTFindWord
86F6: CDA085  			call 	CONSTConvert 						; convert to integer
86F9: DAD986  			jp 		c,COMError 							; failure
86FC: CD8585  			call 	COMUCompileConstant 				; compile as constant.
86FF: E1      			pop 	hl
8700: D1      			pop 	de
8701: C9      			ret
              	;
8702:         	__COMCCompile:
8702: CD7C85  			call 	COMUCompileCall 					; compile a call to E:HL
8705: E1      			pop 	hl
8706: D1      			pop 	de
8707: C9      			ret
              	;
              	
              	; ***************************************************************************************
              	;
              	;						Execute the Yellow tagged word at BC
              	;
              	; ***************************************************************************************
              	
8708:         	COMXExecuteYellowWord:		
8708: D5      			push 	de 									; save A & B
8709: E5      			push 	hl
870A: 3E00    			ld 		a,$00 								; look in normal words
870C: CD4986  			call 	DICTFindWord
870F: 300A    			jr 		nc,__COMXExecuteWord
8711: CDA085  			call 	CONSTConvert 						; check if number
8714: DAD986  			jp 		c,COMError 							; if not, report error.
              	
8717: D1      			pop 	de 									; restore A into DE, keep HL the same
8718: 33      			inc 	sp
8719: 33      			inc 	sp
871A: C9      			ret
              	
871B:         	__COMXExecuteWord:
871B: 7B      			ld 		a,e 								; switch to the relevaant page
871C: CD6083  			call 	PAGESwitch 						
871F: D1      			pop 	de 									; restore A into DE, wrongly.
8720: E3      			ex 		(sp),hl 							; now A and B are the wrong way round and exec is on TOS
8721: EB      			ex 		de,hl 								; A and B are now correct.
8722: DDE3    			ex 		(sp),ix 							; IX now contains address, old IX on TOS
8724: CD2D87  			call 	__CallIX 							; call (IX)
8727: CD7983  			call 	PAGERestore 						; restore original page
872A: DDE1    			pop 	ix 									; restore original IX.
872C: C9      			ret
              	
872D:         	__CallIX:	 										; call here does CALL (IX)
872D: DDE9    			jp 		(ix)
              	
              			
              	
              			include "temp/__words.asm"					; vocabulary file.
              	; =========== ! both ===========
              	
872F:         	start_21_3a_6d:
872F: CD9385  	 call COMUCopyCode
8732: 04      	 db end_21_3a_6d-start_21_3a_6d-4
8733: 73      	    ld   (hl),e
8734: 23      	    inc  hl
8735: 72      	    ld   (hl),d
8736: 2B      	    dec  hl
8737:         	end_21_3a_6d:
              	
8737:         	start_21_3a_66:
8737: 73      	    ld   (hl),e
8738: 23      	    inc  hl
8739: 72      	    ld   (hl),d
873A: 2B      	    dec  hl
873B: C9      	    ret
              	
              	; =========== * word ===========
              	
873C:         	start_2a_3a_66:
873C: CD6081  	    call  MULTMultiply16
873F: C9      	    ret
              	
              	; =========== + both ===========
              	
8740:         	start_2b_3a_6d:
8740: CD9385  	 call COMUCopyCode
8743: 01      	 db end_2b_3a_6d-start_2b_3a_6d-4
8744: 19      	    add  hl,de
8745:         	end_2b_3a_6d:
              	
8745:         	start_2b_3a_66:
8745: 19      	    add  hl,de
8746: C9      	    ret
              	
              	; =========== +! word ===========
              	
8747:         	start_2b_21_3a_66:
8747: 7E      	    ld   a,(hl)
8748: 83      	    add  a,e
8749: 77      	    ld   (hl),a
874A: 23      	    inc  hl
874B: 7E      	    ld   a,(hl)
874C: 8A      	    adc  a,d
874D: 77      	    ld   (hl),a
874E: 2B      	    dec  hl
874F: C9      	    ret
              	
              	; =========== ++ both ===========
              	
8750:         	start_2b_2b_3a_6d:
8750: CD9385  	 call COMUCopyCode
8753: 01      	 db end_2b_2b_3a_6d-start_2b_2b_3a_6d-4
8754: 23      	    inc  hl
8755:         	end_2b_2b_3a_6d:
              	
8755:         	start_2b_2b_3a_66:
8755: 23      	    inc  hl
8756: C9      	    ret
              	
              	; =========== +++ both ===========
              	
8757:         	start_2b_2b_2b_3a_6d:
8757: CD9385  	 call COMUCopyCode
875A: 02      	 db end_2b_2b_2b_3a_6d-start_2b_2b_2b_3a_6d-4
875B: 23      	    inc  hl
875C: 23      	    inc  hl
875D:         	end_2b_2b_2b_3a_6d:
              	
875D:         	start_2b_2b_2b_3a_66:
875D: 23      	    inc  hl
875E: 23      	    inc  hl
875F: C9      	    ret
              	
              	; =========== +or word ===========
              	
8760:         	start_2b_6f_72_3a_66:
8760: 7C      	    ld   a,h
8761: B2      	    or   d
8762: 67      	    ld   h,a
8763: 7D      	    ld   a,l
8764: B3      	    or   e
8765: 6F      	    ld   l,a
8766: C9      	    ret
              	
              	; =========== - both ===========
              	
8767:         	start_2d_3a_6d:
8767: CD9385  	 call COMUCopyCode
876A: 06      	 db end_2d_3a_6d-start_2d_3a_6d-4
876B: 7C      	    ld   a,h
876C: 2F      	    cpl
876D: 67      	    ld   h,a
876E: 7D      	    ld   a,l
876F: 2F      	    cpl
8770: 6F      	    ld   l,a
8771:         	end_2d_3a_6d:
              	
8771:         	start_2d_3a_66:
8771: 7C      	    ld   a,h
8772: 2F      	    cpl
8773: 67      	    ld   h,a
8774: 7D      	    ld   a,l
8775: 2F      	    cpl
8776: 6F      	    ld   l,a
8777: C9      	    ret
              	
              	; =========== -- both ===========
              	
8778:         	start_2d_2d_3a_6d:
8778: CD9385  	 call COMUCopyCode
877B: 01      	 db end_2d_2d_3a_6d-start_2d_2d_3a_6d-4
877C: 2B      	    dec  hl
877D:         	end_2d_2d_3a_6d:
              	
877D:         	start_2d_2d_3a_66:
877D: 2B      	    dec  hl
877E: C9      	    ret
              	
              	; =========== --- both ===========
              	
877F:         	start_2d_2d_2d_3a_6d:
877F: CD9385  	 call COMUCopyCode
8782: 02      	 db end_2d_2d_2d_3a_6d-start_2d_2d_2d_3a_6d-4
8783: 2B      	    dec  hl
8784: 2B      	    dec  hl
8785:         	end_2d_2d_2d_3a_6d:
              	
8785:         	start_2d_2d_2d_3a_66:
8785: 2B      	    dec  hl
8786: 2B      	    dec  hl
8787: C9      	    ret
              	
              	; =========== / word ===========
              	
8788:         	start_2f_3a_66:
8788: D5      	    push  de
8789: CD7A81  	    call  DIVDivideMod16
878C: EB      	    ex   de,hl
878D: D1      	    pop  de
878E: C9      	    ret
              	
              	; =========== /mod word ===========
              	
878F:         	start_2f_6d_6f_64_3a_66:
878F: CD7A81  	    call  DIVDivideMod16
8792: EB      	    ex  de,hl
8793: C9      	    ret
              	
              	; =========== 1, word ===========
              	
8794:         	start_31_2c_3a_66:
8794: 7D      	    ld   a,l
8795: CDA581  	    call  FARCompileByte
8798: C9      	    ret
              	
              	; =========== 2* both ===========
              	
8799:         	start_32_2a_3a_6d:
8799: CD9385  	 call COMUCopyCode
879C: 01      	 db end_32_2a_3a_6d-start_32_2a_3a_6d-4
879D: 29      	    add  hl,hl
879E:         	end_32_2a_3a_6d:
              	
879E:         	start_32_2a_3a_66:
879E: 29      	    add  hl,hl
879F: C9      	    ret
              	
              	; =========== 2, word ===========
              	
87A0:         	start_32_2c_3a_66:
87A0: CDBD81  	    call FARCompileWord
87A3: C9      	    ret
              	
              	; =========== 2/ both ===========
              	
87A4:         	start_32_2f_3a_6d:
87A4: CD9385  	 call COMUCopyCode
87A7: 04      	 db end_32_2f_3a_6d-start_32_2f_3a_6d-4
87A8: CB2C    	    sra  h
87AA: CB1D    	    rr   l
87AC:         	end_32_2f_3a_6d:
              	
87AC:         	start_32_2f_3a_66:
87AC: CB2C    	    sra  h
87AE: CB1D    	    rr   l
87B0: C9      	    ret
              	
              	; =========== ; macro ===========
              	
87B1:         	start_3b_3a_6d:
87B1: CD9385  	 call COMUCopyCode
87B4: 01      	 db end_3b_3a_6d-start_3b_3a_6d-4
87B5: C9      	    ret
87B6:         	end_3b_3a_6d:
              	
              	; =========== < word ===========
              	
87B6:         	start_3c_3a_66:
              	    ; checking if B < A
87B6: 7C      	    ld   a,h         ; signs different ??
87B7: AA      	    xor  d
87B8: FAC687  	    jp   m,__Less_DiffSigns
87BB: D5      	    push  de
87BC: EB      	    ex   de,hl         ; HL = B, DE = A
87BD: ED52    	    sbc  hl,de         ; calculate B-A, CS if -ve e.g. B < A
87BF: D1      	    pop  de
87C0: 210000  	    ld   hl,$0000        ; so return 0 if B-A doesn't generate a borrow
87C3: D0      	    ret  nc
87C4: 2B      	    dec  hl
87C5: C9      	    ret
87C6:         	__Less_DiffSigns:
87C6: CB7A    	    bit  7,d         ; if B bit 7 is set, -ve B must be < A
87C8: 210000  	    ld   hl,$0000
87CB: C8      	    ret  z          ; so return zero if not set
87CC: 2B      	    dec  hl
87CD: C9      	    ret
87CE: C9      	    ret
              	
              	; =========== = word ===========
              	
87CF:         	start_3d_3a_66:
87CF: 7C      	    ld   a,h         ; D = H^D
87D0: AA      	    xor  d
87D1: 67      	    ld   h,a
87D2: 7D      	    ld   a,l         ; A = L^E | H^D
87D3: AB      	    xor  e
87D4: B4      	    or   h
87D5: 210000  	    ld   hl,$0000        ; return 0 if any differences.
87D8: C0      	    ret  nz
87D9: 2B      	    dec  hl
87DA: C9      	    ret
              	
              	; =========== @ both ===========
              	
87DB:         	start_40_3a_6d:
87DB: CD9385  	 call COMUCopyCode
87DE: 04      	 db end_40_3a_6d-start_40_3a_6d-4
87DF: 7E      	    ld   a,(hl)
87E0: 23      	    inc  hl
87E1: 66      	    ld   h,(hl)
87E2: 6F      	    ld   l,a
87E3:         	end_40_3a_6d:
              	
87E3:         	start_40_3a_66:
87E3: 7E      	    ld   a,(hl)
87E4: 23      	    inc  hl
87E5: 66      	    ld   h,(hl)
87E6: 6F      	    ld   l,a
87E7: C9      	    ret
              	
              	; =========== a>b both ===========
              	
87E8:         	start_61_3e_62_3a_6d:
87E8: CD9385  	 call COMUCopyCode
87EB: 02      	 db end_61_3e_62_3a_6d-start_61_3e_62_3a_6d-4
87EC: 5D      	    ld   e,l
87ED: 54      	    ld   d,h
87EE:         	end_61_3e_62_3a_6d:
              	
87EE:         	start_61_3e_62_3a_66:
87EE: 5D      	    ld   e,l
87EF: 54      	    ld   d,h
87F0: C9      	    ret
              	
              	; =========== a>r macro ===========
              	
87F1:         	start_61_3e_72_3a_6d:
87F1: CD9385  	 call COMUCopyCode
87F4: 01      	 db end_61_3e_72_3a_6d-start_61_3e_72_3a_6d-4
87F5: E5      	    push  hl
87F6:         	end_61_3e_72_3a_6d:
              	
              	; =========== ab>r macro ===========
              	
87F6:         	start_61_62_3e_72_3a_6d:
87F6: CD9385  	 call COMUCopyCode
87F9: 02      	 db end_61_62_3e_72_3a_6d-start_61_62_3e_72_3a_6d-4
87FA: E5      	    push  hl
87FB: D5      	    push  de
87FC:         	end_61_62_3e_72_3a_6d:
              	
              	; =========== abs word ===========
              	
87FC:         	start_61_62_73_3a_66:
87FC: CB7C    	    bit  7,h
87FE: C29188  	    jp   nz,__Negate
8801: C9      	    ret
              	
              	; =========== and word ===========
              	
8802:         	start_61_6e_64_3a_66:
8802: 7C      	    ld   a,h
8803: A2      	    and  d
8804: 67      	    ld   h,a
8805: 7D      	    ld   a,l
8806: A3      	    and  e
8807: 6F      	    ld   l,a
8808: C9      	    ret
              	
              	; =========== b! both ===========
              	
8809:         	start_62_21_3a_6d:
8809: CD9385  	 call COMUCopyCode
880C: 01      	 db end_62_21_3a_6d-start_62_21_3a_6d-4
880D: 73      	    ld   (hl),e
880E:         	end_62_21_3a_6d:
              	
880E:         	start_62_21_3a_66:
880E: 73      	    ld   (hl),e
880F: C9      	    ret
              	
              	; =========== b>a both ===========
              	
8810:         	start_62_3e_61_3a_6d:
8810: CD9385  	 call COMUCopyCode
8813: 02      	 db end_62_3e_61_3a_6d-start_62_3e_61_3a_6d-4
8814: 6B      	    ld   l,e
8815: 62      	    ld   h,d
8816:         	end_62_3e_61_3a_6d:
              	
8816:         	start_62_3e_61_3a_66:
8816: 6B      	    ld   l,e
8817: 62      	    ld   h,d
8818: C9      	    ret
              	
              	; =========== b>r macro ===========
              	
8819:         	start_62_3e_72_3a_6d:
8819: CD9385  	 call COMUCopyCode
881C: 01      	 db end_62_3e_72_3a_6d-start_62_3e_72_3a_6d-4
881D: D5      	    push  de
881E:         	end_62_3e_72_3a_6d:
              	
              	; =========== b@ both ===========
              	
881E:         	start_62_40_3a_6d:
881E: CD9385  	 call COMUCopyCode
8821: 03      	 db end_62_40_3a_6d-start_62_40_3a_6d-4
8822: 6E      	    ld   l,(hl)
8823: 2600    	    ld   h,$00
8825:         	end_62_40_3a_6d:
              	
8825:         	start_62_40_3a_66:
8825: 6E      	    ld   l,(hl)
8826: 2600    	    ld   h,$00
8828: C9      	    ret
              	
              	; =========== break macro ===========
              	
8829:         	start_62_72_65_61_6b_3a_6d:
8829: CD9385  	 call COMUCopyCode
882C: 02      	 db end_62_72_65_61_6b_3a_6d-start_62_72_65_61_6b_3a_6d-4
882D: DD01    	    db   $DD,$01
882F:         	end_62_72_65_61_6b_3a_6d:
              	
              	; =========== bswap both ===========
              	
882F:         	start_62_73_77_61_70_3a_6d:
882F: CD9385  	 call COMUCopyCode
8832: 03      	 db end_62_73_77_61_70_3a_6d-start_62_73_77_61_70_3a_6d-4
8833: 7C      	    ld   a,h
8834: 65      	    ld   h,l
8835: 6F      	    ld   l,a
8836:         	end_62_73_77_61_70_3a_6d:
              	
8836:         	start_62_73_77_61_70_3a_66:
8836: 7C      	    ld   a,h
8837: 65      	    ld   h,l
8838: 6F      	    ld   l,a
8839: C9      	    ret
              	
              	; =========== compiles word ===========
              	
883A:         	start_63_6f_6d_70_69_6c_65_73_3a_66:
883A: CD3586  	    call  DICTMakeLastCompiles     ; make the last word defined a 'commands' (e.g. immediate)
883D: C9      	    ret
              	
              	; =========== copy word ===========
              	
883E:         	start_63_6f_70_79_3a_66:
              	    ; B (DE) = source A (HL) = target
883E: ED4BEF8B	    ld   bc,(Parameter)       ; get count
8842: 78      	    ld   a,b         ; zero check
8843: B1      	    or   c
8844: 2817    	    jr   z,__copyExit
8846: D5      	    push  de          ; save A/B
8847: E5      	    push  hl
8848: AF      	    xor  a          ; find direction.
8849: ED52    	    sbc  hl,de
884B: 7C      	    ld   a,h
884C: 19      	    add  hl,de
884D: CB7F    	    bit  7,a         ; if +ve use LDDR
884F: 2805    	    jr   z,__copy2
8851: EB      	    ex   de,hl         ; LDIR etc do (DE) <- (HL)
8852: EDB0    	    ldir
8854: 1807    	    jr   __copyExit
8856:         	__copy2:
8856: 09      	    add  hl,bc         ; add length to HL,DE, swap as LDDR does (DE) <- (HL)
8857: EB      	    ex   de,hl
8858: 09      	    add  hl,bc
8859: 1B      	    dec  de          ; -1 to point to last byte
885A: 2B      	    dec  hl
885B: EDB8    	    lddr
885D:         	__copyExit:
885D: E1      	    pop  hl
885E: D1      	    pop  de
885F: C9      	    ret
              	
              	; =========== debug word ===========
              	
8860:         	start_64_65_62_75_67_3a_66:
8860: CDEA80  	    call  DEBUGShow
8863: C9      	    ret
              	
              	; =========== fill word ===========
              	
8864:         	start_66_69_6c_6c_3a_66:
8864: ED4BEF8B	    ld   bc,(Parameter)       ; count to do.
8868: 78      	    ld   a,b
8869: B1      	    or   c
886A: 2809    	    jr   z,__fillExit       ; if count zero exit.
886C: D5      	    push  de
886D: E5      	    push  hl
886E:         	__fillLoop:
886E: 73      	    ld   (hl),e
886F: 23      	    inc  hl
8870: 0B      	    dec  bc
8871: 78      	    ld   a,b
8872: B1      	    or   c
8873: 20F9    	    jr   nz,__fillLoop
8875:         	__fillExit:
8875: E1      	    pop  hl
8876: D1      	    pop  de
8877: C9      	    ret
              	
              	; =========== h word ===========
              	
8878:         	start_68_3a_66:
8878: EB      	    ex   de,hl
8879: 21E38B  	    ld   hl,Here
887C: C9      	    ret
              	
              	; =========== halt word ===========
              	
887D:         	start_68_61_6c_74_3a_66:
887D:         	__haltz80:
887D: F3      	    di
887E: 76      	    halt
887F: 18FC    	    jr   __haltz80
8881: C9      	    ret
              	
              	; =========== here word ===========
              	
8882:         	start_68_65_72_65_3a_66:
8882: EB      	    ex   de,hl
8883: 2AE38B  	    ld   hl,(Here)
8886: C9      	    ret
              	
              	; =========== hex! word ===========
              	
8887:         	start_68_65_78_21_3a_66:
              	    ; DE = word, HL = pos
8887: CD2A82  	    call  GFXWriteHexWord      ; write out the word
888A: C9      	    ret
              	
              	; =========== mod word ===========
              	
888B:         	start_6d_6f_64_3a_66:
888B: D5      	    push  de
888C: CD7A81  	    call  DIVDivideMod16
888F: D1      	    pop  de
8890: C9      	    ret
              	
              	; =========== negate word ===========
              	
8891:         	start_6e_65_67_61_74_65_3a_66:
8891:         	__Negate:
8891: 7C      	    ld   a,h
8892: 2F      	    cpl
8893: 67      	    ld   h,a
8894: 7D      	    ld   a,l
8895: 2F      	    cpl
8896: 6F      	    ld   l,a
8897: 23      	    inc  hl
8898: C9      	    ret
              	
              	; =========== or word ===========
              	
8899:         	start_6f_72_3a_66:
8899: 7C      	    ld   a,h
889A: AA      	    xor  d
889B: 67      	    ld   h,a
889C: 7D      	    ld   a,l
889D: AB      	    xor  e
889E: 6F      	    ld   l,a
889F: C9      	    ret
              	
              	; =========== or! word ===========
              	
88A0:         	start_6f_72_21_3a_66:
88A0: 7E      	    ld   a,(hl)
88A1: B3      	    or   e
88A2: 77      	    ld   (hl),a
88A3: 23      	    inc  hl
88A4: 7E      	    ld   a,(hl)
88A5: B2      	    or   d
88A6: 77      	    ld   (hl),a
88A7: 2B      	    dec  hl
88A8: C9      	    ret
              	
              	; =========== p! both ===========
              	
88A9:         	start_70_21_3a_6d:
88A9: CD9385  	 call COMUCopyCode
88AC: 04      	 db end_70_21_3a_6d-start_70_21_3a_6d-4
88AD: 4D      	    ld   c,l
88AE: 44      	    ld   b,h
88AF: ED59    	    out  (c),e
88B1:         	end_70_21_3a_6d:
              	
88B1:         	start_70_21_3a_66:
88B1: 4D      	    ld   c,l
88B2: 44      	    ld   b,h
88B3: ED59    	    out  (c),e
88B5: C9      	    ret
              	
              	; =========== p@ word ===========
              	
88B6:         	start_70_40_3a_66:
88B6: 4D      	    ld   c,l
88B7: 44      	    ld   b,h
88B8: ED68    	    in   l,(c)
88BA: 2600    	    ld   h,0
88BC: C9      	    ret
              	
              	; =========== param! word ===========
              	
88BD:         	start_70_61_72_61_6d_21_3a_66:
88BD: 22EF8B  	    ld   (Parameter),hl
88C0: C9      	    ret
              	
              	; =========== pop macro ===========
              	
88C1:         	start_70_6f_70_3a_6d:
88C1: CD9385  	 call COMUCopyCode
88C4: 02      	 db end_70_6f_70_3a_6d-start_70_6f_70_3a_6d-4
88C5: EB      	    ex   de,hl
88C6: E1      	    pop  hl
88C7:         	end_70_6f_70_3a_6d:
              	
              	; =========== push macro ===========
              	
88C7:         	start_70_75_73_68_3a_6d:
88C7: CD9385  	 call COMUCopyCode
88CA: 01      	 db end_70_75_73_68_3a_6d-start_70_75_73_68_3a_6d-4
88CB: E5      	    push  hl
88CC:         	end_70_75_73_68_3a_6d:
              	
              	; =========== r>a macro ===========
              	
88CC:         	start_72_3e_61_3a_6d:
88CC: CD9385  	 call COMUCopyCode
88CF: 01      	 db end_72_3e_61_3a_6d-start_72_3e_61_3a_6d-4
88D0: E1      	    pop  hl
88D1:         	end_72_3e_61_3a_6d:
              	
              	; =========== r>ab macro ===========
              	
88D1:         	start_72_3e_61_62_3a_6d:
88D1: CD9385  	 call COMUCopyCode
88D4: 02      	 db end_72_3e_61_62_3a_6d-start_72_3e_61_62_3a_6d-4
88D5: D1      	    pop  de
88D6: E1      	    pop  hl
88D7:         	end_72_3e_61_62_3a_6d:
              	
              	; =========== r>b macro ===========
              	
88D7:         	start_72_3e_62_3a_6d:
88D7: CD9385  	 call COMUCopyCode
88DA: 01      	 db end_72_3e_62_3a_6d-start_72_3e_62_3a_6d-4
88DB: D1      	    pop  de
88DC:         	end_72_3e_62_3a_6d:
              	
              	; =========== swap both ===========
              	
88DC:         	start_73_77_61_70_3a_6d:
88DC: CD9385  	 call COMUCopyCode
88DF: 01      	 db end_73_77_61_70_3a_6d-start_73_77_61_70_3a_6d-4
88E0: EB      	    ex   de,hl         ; 2nd now TOS
88E1:         	end_73_77_61_70_3a_6d:
              	
88E1:         	start_73_77_61_70_3a_66:
88E1: EB      	    ex   de,hl         ; 2nd now TOS
88E2: C9      	    ret
              	
              			
88E3:         	AlternateFont:										; nicer font
              			include "font.inc" 							; can be $3D00 here to save memory
88E3: 00000000	  db 0,0,0,0,0,0,0,0,12,30,30,12,12,0,12,0,54,54,0,0,0,0,0,0,54,54,127,54,127,54,54,0,24,62,96,60,6,124,24,0,0,99,102,12,24,51,99,0,28,54,28,59,110,102,59,0,48,48,96,0,0,0,0,0,12,24,48,48,48,24,12,0,48,24,12,12,12,24,48,0,0,51,30,127,30,51,0,0,0,24,24,126,24,24,0,0,0,0,0,0,0,24,24,48,0,0,0,126,0,0,0,0,0,0,0,0,0,24,24,0,3,6,12,24,48,96,64,0,62,99,103,111,123,115,62,0,24,56,24,24,24,24,126,0,60,102,6,28,48,102,126,0,60,102,6,28,6,102,60,0,14,30,54,102,127,6,15,0,126,96,124,6,6,102,60,0,28,48,96,124,102,102,60,0,126,102,6,12,24,24,24,0,60,102,102,60,102,102,60,0,60,102,102,62,6,12,56,0,0,24,24,0,0,24,24,0,0,24,24,0,0,24,24,48,12,24,48,96,48,24,12,0,0,0,126,0,0,126,0,0,48,24,12,6,12,24,48,0,60,102,6,12,24,0,24,0,62,99,111,111,111,96,60,0,24,60,102,102,126,102,102,0,126,51,51,62,51,51,126,0,30,51,96,96,96,51,30,0,124,54,51,51,51,54,124,0,127,49,52,60,52,49,127,0,127,49,52,60,52,48,120,0,30,51,96,96,103,51,31,0,102,102,102,126,102,102,102,0,60,24,24,24,24,24,60,0,15,6,6,6,102,102,60,0,115,51,54,60,54,51,115,0,120,48,48,48,49,51,127,0,99,119,127,127,107,99,99,0,99,115,123,111,103,99,99,0,28,54,99,99,99,54,28,0,126,51,51,62,48,48,120,0,60,102,102,102,110,60,14,0,126,51,51,62,54,51,115,0,60,102,112,56,14,102,60,0,126,90,24,24,24,24,60,0,102,102,102,102,102,102,126,0,102,102,102,102,102,60,24,0,99,99,99,107,127,119,99,0,99,99,54,28,28,54,99,0,102,102,102,60,24,24,60,0,127,99,70,12,25,51,127,0,60,48,48,48,48,48,60,0,96,48,24,12,6,3,1,0,60,12,12,12,12,12,60,0,8,28,54,99,0,0,0,0,0,0,0,0,0,0,0,127,24,24,12,0,0,0,0,0,0,0,60,6,62,102,59,0,112,48,48,62,51,51,110,0,0,0,60,102,96,102,60,0,14,6,6,62,102,102,59,0,0,0,60,102,126,96,60,0,28,54,48,120,48,48,120,0,0,0,59,102,102,62,6,124,112,48,54,59,51,51,115,0,24,0,56,24,24,24,60,0,6,0,6,6,6,102,102,60,112,48,51,54,60,54,115,0,56,24,24,24,24,24,60,0,0,0,102,127,127,107,99,0,0,0,124,102,102,102,102,0,0,0,60,102,102,102,60,0,0,0,110,51,51,62,48,120,0,0,59,102,102,62,6,15,0,0,110,59,51,48,120,0,0,0,62,96,60,6,124,0,8,24,62,24,24,26,12,0,0,0,102,102,102,102,59,0,0,0,102,102,102,60,24,0,0,0,99,107,127,127,54,0,0,0,99,54,28,54,99,0,0,0,102,102,102,62,6,124,0,0,126,76,24,50,126,0,14,24,24,112,24,24,14,0,12,12,12,0,12,12,12,0,112,24,24,14,24,24,112,0,59,110,0,0,0,0,0,0,0,0,0,0,0,0,0,0
88E7: 00000000	
88EB: 0C1E1E0C	
88EF: 0C000C00	
88F3: 36360000	
88F7: 00000000	
88FB: 36367F36	
88FF: 7F363600	
8903: 183E603C	
8907: 067C1800	
890B: 0063660C	
890F: 18336300	
8913: 1C361C3B	
8917: 6E663B00	
891B: 30306000	
891F: 00000000	
8923: 0C183030	
8927: 30180C00	
892B: 30180C0C	
892F: 0C183000	
8933: 00331E7F	
8937: 1E330000	
893B: 0018187E	
893F: 18180000	
8943: 00000000	
8947: 00181830	
894B: 0000007E	
894F: 00000000	
8953: 00000000	
8957: 00181800	
895B: 03060C18	
895F: 30604000	
8963: 3E63676F	
8967: 7B733E00	
896B: 18381818	
896F: 18187E00	
8973: 3C66061C	
8977: 30667E00	
897B: 3C66061C	
897F: 06663C00	
8983: 0E1E3666	
8987: 7F060F00	
898B: 7E607C06	
898F: 06663C00	
8993: 1C30607C	
8997: 66663C00	
899B: 7E66060C	
899F: 18181800	
89A3: 3C66663C	
89A7: 66663C00	
89AB: 3C66663E	
89AF: 060C3800	
89B3: 00181800	
89B7: 00181800	
89BB: 00181800	
89BF: 00181830	
89C3: 0C183060	
89C7: 30180C00	
89CB: 00007E00	
89CF: 007E0000	
89D3: 30180C06	
89D7: 0C183000	
89DB: 3C66060C	
89DF: 18001800	
89E3: 3E636F6F	
89E7: 6F603C00	
89EB: 183C6666	
89EF: 7E666600	
89F3: 7E33333E	
89F7: 33337E00	
89FB: 1E336060	
89FF: 60331E00	
8A03: 7C363333	
8A07: 33367C00	
8A0B: 7F31343C	
8A0F: 34317F00	
8A13: 7F31343C	
8A17: 34307800	
8A1B: 1E336060	
8A1F: 67331F00	
8A23: 6666667E	
8A27: 66666600	
8A2B: 3C181818	
8A2F: 18183C00	
8A33: 0F060606	
8A37: 66663C00	
8A3B: 7333363C	
8A3F: 36337300	
8A43: 78303030	
8A47: 31337F00	
8A4B: 63777F7F	
8A4F: 6B636300	
8A53: 63737B6F	
8A57: 67636300	
8A5B: 1C366363	
8A5F: 63361C00	
8A63: 7E33333E	
8A67: 30307800	
8A6B: 3C666666	
8A6F: 6E3C0E00	
8A73: 7E33333E	
8A77: 36337300	
8A7B: 3C667038	
8A7F: 0E663C00	
8A83: 7E5A1818	
8A87: 18183C00	
8A8B: 66666666	
8A8F: 66667E00	
8A93: 66666666	
8A97: 663C1800	
8A9B: 6363636B	
8A9F: 7F776300	
8AA3: 6363361C	
8AA7: 1C366300	
8AAB: 6666663C	
8AAF: 18183C00	
8AB3: 7F63460C	
8AB7: 19337F00	
8ABB: 3C303030	
8ABF: 30303C00	
8AC3: 6030180C	
8AC7: 06030100	
8ACB: 3C0C0C0C	
8ACF: 0C0C3C00	
8AD3: 081C3663	
8AD7: 00000000	
8ADB: 00000000	
8ADF: 0000007F	
8AE3: 18180C00	
8AE7: 00000000	
8AEB: 00003C06	
8AEF: 3E663B00	
8AF3: 7030303E	
8AF7: 33336E00	
8AFB: 00003C66	
8AFF: 60663C00	
8B03: 0E06063E	
8B07: 66663B00	
8B0B: 00003C66	
8B0F: 7E603C00	
8B13: 1C363078	
8B17: 30307800	
8B1B: 00003B66	
8B1F: 663E067C	
8B23: 7030363B	
8B27: 33337300	
8B2B: 18003818	
8B2F: 18183C00	
8B33: 06000606	
8B37: 0666663C	
8B3B: 70303336	
8B3F: 3C367300	
8B43: 38181818	
8B47: 18183C00	
8B4B: 0000667F	
8B4F: 7F6B6300	
8B53: 00007C66	
8B57: 66666600	
8B5B: 00003C66	
8B5F: 66663C00	
8B63: 00006E33	
8B67: 333E3078	
8B6B: 00003B66	
8B6F: 663E060F	
8B73: 00006E3B	
8B77: 33307800	
8B7B: 00003E60	
8B7F: 3C067C00	
8B83: 08183E18	
8B87: 181A0C00	
8B8B: 00006666	
8B8F: 66663B00	
8B93: 00006666	
8B97: 663C1800	
8B9B: 0000636B	
8B9F: 7F7F3600	
8BA3: 00006336	
8BA7: 1C366300	
8BAB: 00006666	
8BAF: 663E067C	
8BB3: 00007E4C	
8BB7: 18327E00	
8BBB: 0E181870	
8BBF: 18180E00	
8BC3: 0C0C0C00	
8BC7: 0C0C0C00	
8BCB: 7018180E	
8BCF: 18187000	
8BD3: 3B6E0000	
8BD7: 00000000	
8BDB: 00...   	
              	
              			include "data.asm"		
              	; ***************************************************************************************
              	; ***************************************************************************************
              	;
              	;		Name : 		data.asm
              	;		Author :	Paul Robson (paul@robsons.org.uk)
              	;		Date : 		12th December 2018
              	;		Purpose :	Data area
              	;
              	; ***************************************************************************************
              	; ***************************************************************************************
              	
              	; ***************************************************************************************
              	;
              	;								System Information
              	;
              	; ***************************************************************************************
              	
8BE3:         	SystemInformation:
              	
8BE3:         	Here:												; +0 	Here 
8BE3: 00A0    			dw 		FreeMemory
8BE5:         	HerePage: 											; +2	Here.Page
8BE5: 2A00    			db 		FirstCodePage,0
8BE7:         	NextFreePage: 										; +4 	Next available code page.
8BE7: 2B000000			db 		FirstCodePage+1,0,0,0
8BEB:         	DisplayInfo: 										; +8 	Display information
8BEB: F38B0000			dw 		DisplayInformation,0		
8BEF:         	Parameter: 											; +12 	Third Parameter used in some functions.
8BEF: 00000000			dw 		0,0
              	
              	; ***************************************************************************************
              	;
              	;							 Display system information
              	;
              	; ***************************************************************************************
              	
8BF3:         	DisplayInformation:
              	
8BF3:         	__DIScreenWidth: 									; +0 	screen width
8BF3: 00000000			db 		0,0,0,0
8BF7:         	__DIScreenHeight:									; +4 	screen height
8BF7: 00000000			db 		0,0,0,0
8BFB:         	__DIScreenSize:										; +8 	char size of screen
8BFB: 00000000			dw 		0,0		
8BFF:         	__DIScreenMode:										; +12 	current mode
8BFF: 00000000			db 		0,0,0,0
8C03:         	__DIFontBase:										; font in use
8C03: E388    			dw 		AlternateFont
8C05:         	__DIScreenDriver:									; Screen Driver
8C05: 0000    			dw 		0	
              	
              	; ***************************************************************************************
              	;
              	;								 Other data and buffers
              	;
              	; ***************************************************************************************
              	
8C07:         	__ARegister:										; register values when not running.
8C07: 0000    			dw 		0
8C09:         	__BRegister:
8C09: 0000    			dw 		0
              	
8C0B:         	__DICTLastWordDefined: 								; address of last word defined.
8C0B: 0000    			dw 		0
              	
8C0D:         	__PAGEStackPointer: 								; stack used for switching pages
8C0D: 0000    			dw 		0
8C0F:         	__PAGEStackBase:
8C0F: FFFFFFFF			ds 		16
8C13: FF...   	
              	
8C1F:         	__CLICurrentKey: 									; current inkey state on CLI
8C1F: 00      			db 		0
              	
8C20: 86      			db 		$86 								; buffer for executing, tags it yellow effectively.
8C21:         	__CLIBuffer:
8C21: FFFFFFFF			ds 		20
8C25: FF...   	
              	
8C35: FFFFFFFF			org 	$A000
8C39: FF...   	
A000:         	FreeMemory:		
A000: FFFFFFFF			org 	$C000
A004: FF...   	
C000: 00      			db 		0 									; start of dictionary, which is empty.
              	


; +++ segments +++

#CODE          = $8000 = 32768,  size = $4001 = 16385

; +++ global symbols +++

AlternateFont            = $88E3 = 35043          kernel.asm:64
BUFFScan                 = $8523 = 34083          buffer.asm:18
Boot                     = $8006 = 32774          kernel.asm:32
COMCCompileGreenWord     = $86E3 = 34531          compiler.asm:78
COMCompileWordList       = $86AF = 34479          compiler.asm:18
COMDCompileRedWord       = $86DF = 34527          compiler.asm:68
COMError                 = $86D9 = 34521          compiler.asm:55
COMUCompileCall          = $857C = 34172          utility.asm:18
COMUCompileConstant      = $8585 = 34181          utility.asm:33
COMUCopyCode             = $8593 = 34195          utility.asm:47
COMXExecuteYellowWord    = $8708 = 34568          compiler.asm:108
CONSTConvert             = $85A0 = 34208          constant.asm:19
CommandLineStart         = $801A = 32794          command.asm:12
DEBUGShow                = $80EA = 33002          debug.asm:12
DICTAddWord              = $85DD = 34269          dictionary.asm:19
DICTFindWord             = $8649 = 34377          dictionary.asm:109
DICTMakeLastCompiles     = $8635 = 34357          dictionary.asm:88
DIVDivideMod16           = $817A = 33146          divide.asm:18
DictionaryPage           = $0020 =    32          kernel.asm:16
DisplayInfo              = $8BEB = 35819          data.asm:26 (unused)
DisplayInformation       = $8BF3 = 35827          data.asm:37
Div16_Loop1              = $8184 = 33156          divide.asm:27
Div16_Loop2              = $8195 = 33173          divide.asm:41
Div16_NoAdd1             = $818C = 33164          divide.asm:33
Div16_NoAdd2             = $819D = 33181          divide.asm:47
EditBuffer               = $7B08 = 31496          kernel.asm:24
EditPageSize             = $0200 =   512          kernel.asm:19
ErrorHandler             = $8028 = 32808          command.asm:20
FARCompileByte           = $81A5 = 33189          farmemory.asm:18
FARCompileWord           = $81BD = 33213          farmemory.asm:40
FirstCodePage            = $002A =    42          kernel.asm:20
FirstSourcePage          = $0022 =    34          kernel.asm:17
FreeMemory               = $A000 = 40960          data.asm:79
GFXClearScreen           = $81D8 = 33240          graphics.asm:18 (unused)
GFXGetFontGraphicDE      = $825C = 33372          graphics.asm:145
GFXInitialise48k         = $838F = 33679          screen48k.asm:19
GFXInitialiseLayer2      = $83F2 = 33778          screen_layer2.asm:19
GFXInitialiseLowRes      = $849E = 33950          screen_lores.asm:18
GFXMode                  = $81E2 = 33250          graphics.asm:33
GFXModeE                 = $81E1 = 33249          graphics.asm:31 (unused)
GFXPrintCharacter48k     = $83BB = 33723          screen48k.asm:53
GFXPrintCharacterLayer2  = $8422 = 33826          screen_layer2.asm:56
GFXPrintCharacterLowRes  = $84C8 = 33992          screen_lores.asm:50
GFXWriteCharacter        = $8217 = 33303          graphics.asm:77
GFXWriteHexWord          = $822A = 33322          graphics.asm:100
GFXWriteHexWordA         = $822C = 33324          graphics.asm:102 (unused)
Here                     = $8BE3 = 35811          data.asm:20
HerePage                 = $8BE5 = 35813          data.asm:22
IOScanKeyboard           = $8281 = 33409          keyboard.asm:18
L2PClear                 = $83FB = 33787          screen_layer2.asm:26
L2PClearBank             = $840B = 33803          screen_layer2.asm:35
LowClearScreen           = $84B1 = 33969          screen_lores.asm:30
MULTMultiply16           = $8160 = 33120          multiply.asm:18
NextFreePage             = $8BE7 = 35815          data.asm:24 (unused)
PAGEInitialise           = $834E = 33614          paging.asm:18
PAGERestore              = $8379 = 33657          paging.asm:64
PAGESwitch               = $8360 = 33632          paging.asm:36
Parameter                = $8BEF = 35823          data.asm:28
SourcePageCount          = $0004 =     4          kernel.asm:18
StackTop                 = $7EFC = 32508          kernel.asm:25
SystemInformation        = $8BE3 = 35811          data.asm:18
WarmStart                = $8021 = 32801          command.asm:16
WarmStartSetup           = $802A = 32810          command.asm:22
__ARegister              = $8C07 = 35847          data.asm:58
__BRegister              = $8C09 = 35849          data.asm:60
__BUFFNextPage           = $8568 = 34152          buffer.asm:57
__BUFFScanNextPageInBuffer = $8540 = 34112          buffer.asm:36
__BUFFScanSourcePage     = $8538 = 34104          buffer.asm:29
__CLIBuffer              = $8C21 = 35873          data.asm:75
__CLIChangeLoop          = $80C8 = 32968          command.asm:112
__CLIClear               = $803C = 32828          command.asm:33
__CLICurrentKey          = $8C1F = 35871          data.asm:71
__CLIExecute             = $809B = 32923          command.asm:87
__CLIGetChange           = $80C3 = 32963          command.asm:108
__CLIGetKey              = $80BC = 32956          command.asm:103
__CLILoop                = $8072 = 32882          command.asm:64
__CLIPrompt              = $804E = 32846          command.asm:45
__CLIPromptExit          = $805D = 32861          command.asm:55
__CLIWarmStart           = $80E4 = 32996          command.asm:122
__CLIWelcome             = $80D3 = 32979          command.asm:120
__COMCCompile            = $8702 = 34562          compiler.asm:95
__COMUCopyLoop           = $8596 = 34198          utility.asm:51
__COMWExit               = $86D5 = 34517          compiler.asm:48
__COMWLoop               = $86B2 = 34482          compiler.asm:22
__COMWNext               = $86CD = 34509          compiler.asm:41
__COMXExecuteWord        = $871B = 34587          compiler.asm:122
__CONConFail             = $85DA = 34266          constant.asm:75
__CONConvLoop            = $85A7 = 34215          constant.asm:27
__CONMinusExit           = $85CA = 34250          constant.asm:56
__CONNotNegative         = $85D7 = 34263          constant.asm:70
__CallIX                 = $872D = 34605          compiler.asm:134
__Core__Mult_Loop        = $8167 = 33127          multiply.asm:24
__Core__Mult_Shift       = $816C = 33132          multiply.asm:28
__DEBUGPrintDERecursively = $8147 = 33095          debug.asm:79
__DEBUGPrintDecNotNegative = $8138 = 33080          debug.asm:68
__DEBUGPrintDecimalInteger = $812C = 33068          debug.asm:57
__DEBUGShowClear         = $80F9 = 33017          debug.asm:25
__DICTAddCopy            = $861E = 34334          dictionary.asm:65
__DICTCheckName          = $8677 = 34423          dictionary.asm:141
__DICTCreateEntry        = $8600 = 34304          dictionary.asm:48
__DICTFindEndDictionary  = $85F3 = 34291          dictionary.asm:39
__DICTFindExit           = $86A6 = 34470          dictionary.asm:172
__DICTFindFail           = $869F = 34463          dictionary.asm:168
__DICTFindMainLoop       = $8658 = 34392          dictionary.asm:120
__DICTFindNext           = $8696 = 34454          dictionary.asm:162
__DICTFindNoMatch        = $8693 = 34451          dictionary.asm:159
__DICTLastWordDefined    = $8C0B = 35851          data.asm:63
__DIFontBase             = $8C03 = 35843          data.asm:47
__DIScreenDriver         = $8C05 = 35845          data.asm:49
__DIScreenHeight         = $8BF7 = 35831          data.asm:41
__DIScreenMode           = $8BFF = 35839          data.asm:45
__DIScreenSize           = $8BFB = 35835          data.asm:43
__DIScreenWidth          = $8BF3 = 35827          data.asm:39
__GFXConfigure           = $81FC = 33276          graphics.asm:54
__GFXLayer2              = $81F4 = 33268          graphics.asm:47
__GFXLowRes              = $81F9 = 33273          graphics.asm:51
__GFXPromptCharacter     = $8279 = 33401          graphics.asm:167
__GFXWCExit              = $8225 = 33317          graphics.asm:87
__GFXWHByte              = $823E = 33342          graphics.asm:118
__GFXWHDigit             = $8254 = 33364          graphics.asm:132
__GFXWHNibble            = $824B = 33355          graphics.asm:126
__L2Blank                = $8482 = 33922          screen_layer2.asm:135
__L2Exit                 = $8497 = 33943          screen_layer2.asm:157
__L2Exit1                = $8492 = 33938          screen_layer2.asm:152
__L2Loop                 = $8476 = 33910          screen_layer2.asm:125
__L2Not1                 = $8438 = 33848          screen_layer2.asm:76
__L2Not2                 = $843E = 33854          screen_layer2.asm:80
__L2Not3                 = $8444 = 33860          screen_layer2.asm:84
__L2NotSet               = $847C = 33916          screen_layer2.asm:130
__L2Outer                = $846B = 33899          screen_layer2.asm:118
__LPExit                 = $851C = 34076          screen_lores.asm:120
__Less_DiffSigns         = $87C6 = 34758          __words.asm:213
__LowLoop                = $8508 = 34056          screen_lores.asm:104
__LowNotLower2           = $84FE = 34046          screen_lores.asm:97
__LowNotSet              = $850E = 34062          screen_lores.asm:109
__LowOuter               = $8500 = 34048          screen_lores.asm:99
__Negate                 = $8891 = 34961          __words.asm:479
__PAGEStackBase          = $8C0F = 35855          data.asm:68
__PAGEStackPointer       = $8C0D = 35853          data.asm:66
__ZXWCCopy               = $83E7 = 33767          screen48k.asm:101
__ZXWCExit               = $83ED = 33773          screen48k.asm:107
___kr4                   = $82B2 = 33458          keyboard.asm:49
__copy2                  = $8856 = 34902          __words.asm:399
__copyExit               = $885D = 34909          __words.asm:406
__cs1                    = $839F = 33695          screen48k.asm:29
__cs2                    = $83A7 = 33703          screen48k.asm:34
__fillExit               = $8875 = 34933          __words.asm:433
__fillLoop               = $886E = 34926          __words.asm:426
__haltz80                = $887D = 34941          __words.asm:448
__kr1                    = $8296 = 33430          keyboard.asm:32
__kr2                    = $82A1 = 33441          keyboard.asm:38
__kr3                    = $82A3 = 33443          keyboard.asm:41
__kr_exit                = $82D2 = 33490          keyboard.asm:79
__kr_keypressed          = $82CC = 33484          keyboard.asm:73
__kr_no_shift_table      = $82D6 = 33494          keyboard.asm:94
__kr_shift_table         = $82FE = 33534          keyboard.asm:100
__kr_symbol_shift_table  = $82FE = 33534          keyboard.asm:101
_end                     = $C001 = 49153          kernel.asm:26 (unused)
_size                    = $4001 = 16385          kernel.asm:26 (unused)
end_21_3a_6d             = $8737 = 34615          __words.asm:10
end_2b_2b_2b_3a_6d       = $875D = 34653          __words.asm:69
end_2b_2b_3a_6d          = $8755 = 34645          __words.asm:56
end_2b_3a_6d             = $8745 = 34629          __words.asm:31
end_2d_2d_2d_3a_6d       = $8785 = 34693          __words.asm:128
end_2d_2d_3a_6d          = $877D = 34685          __words.asm:115
end_2d_3a_6d             = $8771 = 34673          __words.asm:98
end_32_2a_3a_6d          = $879E = 34718          __words.asm:164
end_32_2f_3a_6d          = $87AC = 34732          __words.asm:183
end_3b_3a_6d             = $87B6 = 34742          __words.asm:196
end_40_3a_6d             = $87E3 = 34787          __words.asm:244
end_61_3e_62_3a_6d       = $87EE = 34798          __words.asm:260
end_61_3e_72_3a_6d       = $87F6 = 34806          __words.asm:273
end_61_62_3e_72_3a_6d    = $87FC = 34812          __words.asm:282
end_62_21_3a_6d          = $880E = 34830          __words.asm:308
end_62_3e_61_3a_6d       = $8816 = 34838          __words.asm:321
end_62_3e_72_3a_6d       = $881E = 34846          __words.asm:334
end_62_40_3a_6d          = $8825 = 34853          __words.asm:343
end_62_72_65_61_6b_3a_6d = $882F = 34863          __words.asm:356
end_62_73_77_61_70_3a_6d = $8836 = 34870          __words.asm:366
end_70_21_3a_6d          = $88B1 = 34993          __words.asm:521
end_70_6f_70_3a_6d       = $88C7 = 35015          __words.asm:551
end_70_75_73_68_3a_6d    = $88CC = 35020          __words.asm:559
end_72_3e_61_3a_6d       = $88D1 = 35025          __words.asm:567
end_72_3e_61_62_3a_6d    = $88D7 = 35031          __words.asm:576
end_72_3e_62_3a_6d       = $88DC = 35036          __words.asm:584
end_73_77_61_70_3a_6d    = $88E1 = 35041          __words.asm:592
start_21_3a_66           = $8737 = 34615          __words.asm:12 (unused)
start_21_3a_6d           = $872F = 34607          __words.asm:3
start_2a_3a_66           = $873C = 34620          __words.asm:21 (unused)
start_2b_21_3a_66        = $8747 = 34631          __words.asm:39 (unused)
start_2b_2b_2b_3a_66     = $875D = 34653          __words.asm:71 (unused)
start_2b_2b_2b_3a_6d     = $8757 = 34647          __words.asm:64
start_2b_2b_3a_66        = $8755 = 34645          __words.asm:58 (unused)
start_2b_2b_3a_6d        = $8750 = 34640          __words.asm:52
start_2b_3a_66           = $8745 = 34629          __words.asm:33 (unused)
start_2b_3a_6d           = $8740 = 34624          __words.asm:27
start_2b_6f_72_3a_66     = $8760 = 34656          __words.asm:78 (unused)
start_2d_2d_2d_3a_66     = $8785 = 34693          __words.asm:130 (unused)
start_2d_2d_2d_3a_6d     = $877F = 34687          __words.asm:123
start_2d_2d_3a_66        = $877D = 34685          __words.asm:117 (unused)
start_2d_2d_3a_6d        = $8778 = 34680          __words.asm:111
start_2d_3a_66           = $8771 = 34673          __words.asm:100 (unused)
start_2d_3a_6d           = $8767 = 34663          __words.asm:89
start_2f_3a_66           = $8788 = 34696          __words.asm:137 (unused)
start_2f_6d_6f_64_3a_66  = $878F = 34703          __words.asm:146 (unused)
start_31_2c_3a_66        = $8794 = 34708          __words.asm:153 (unused)
start_32_2a_3a_66        = $879E = 34718          __words.asm:166 (unused)
start_32_2a_3a_6d        = $8799 = 34713          __words.asm:160
start_32_2c_3a_66        = $87A0 = 34720          __words.asm:172 (unused)
start_32_2f_3a_66        = $87AC = 34732          __words.asm:185 (unused)
start_32_2f_3a_6d        = $87A4 = 34724          __words.asm:178
start_3b_3a_6d           = $87B1 = 34737          __words.asm:192
start_3c_3a_66           = $87B6 = 34742          __words.asm:200 (unused)
start_3d_3a_66           = $87CF = 34767          __words.asm:223 (unused)
start_40_3a_66           = $87E3 = 34787          __words.asm:246 (unused)
start_40_3a_6d           = $87DB = 34779          __words.asm:237
start_61_3e_62_3a_66     = $87EE = 34798          __words.asm:262 (unused)
start_61_3e_62_3a_6d     = $87E8 = 34792          __words.asm:255
start_61_3e_72_3a_6d     = $87F1 = 34801          __words.asm:269
start_61_62_3e_72_3a_6d  = $87F6 = 34806          __words.asm:277
start_61_62_73_3a_66     = $87FC = 34812          __words.asm:286 (unused)
start_61_6e_64_3a_66     = $8802 = 34818          __words.asm:293 (unused)
start_62_21_3a_66        = $880E = 34830          __words.asm:310 (unused)
start_62_21_3a_6d        = $8809 = 34825          __words.asm:304
start_62_3e_61_3a_66     = $8816 = 34838          __words.asm:323 (unused)
start_62_3e_61_3a_6d     = $8810 = 34832          __words.asm:316
start_62_3e_72_3a_6d     = $8819 = 34841          __words.asm:330
start_62_40_3a_66        = $8825 = 34853          __words.asm:345 (unused)
start_62_40_3a_6d        = $881E = 34846          __words.asm:338
start_62_72_65_61_6b_3a_6d = $8829 = 34857          __words.asm:352
start_62_73_77_61_70_3a_66 = $8836 = 34870          __words.asm:368 (unused)
start_62_73_77_61_70_3a_6d = $882F = 34863          __words.asm:360
start_63_6f_6d_70_69_6c_65_73_3a_66 = $883A = 34874          __words.asm:376 (unused)
start_63_6f_70_79_3a_66  = $883E = 34878          __words.asm:382 (unused)
start_64_65_62_75_67_3a_66 = $8860 = 34912          __words.asm:413 (unused)
start_66_69_6c_6c_3a_66  = $8864 = 34916          __words.asm:419 (unused)
start_68_3a_66           = $8878 = 34936          __words.asm:440 (unused)
start_68_61_6c_74_3a_66  = $887D = 34941          __words.asm:447 (unused)
start_68_65_72_65_3a_66  = $8882 = 34946          __words.asm:456 (unused)
start_68_65_78_21_3a_66  = $8887 = 34951          __words.asm:463 (unused)
start_6d_6f_64_3a_66     = $888B = 34955          __words.asm:470 (unused)
start_6e_65_67_61_74_65_3a_66 = $8891 = 34961          __words.asm:478 (unused)
start_6f_72_21_3a_66     = $88A0 = 34976          __words.asm:502 (unused)
start_6f_72_3a_66        = $8899 = 34969          __words.asm:491 (unused)
start_70_21_3a_66        = $88B1 = 34993          __words.asm:523 (unused)
start_70_21_3a_6d        = $88A9 = 34985          __words.asm:515
start_70_40_3a_66        = $88B6 = 34998          __words.asm:531 (unused)
start_70_61_72_61_6d_21_3a_66 = $88BD = 35005          __words.asm:540 (unused)
start_70_6f_70_3a_6d     = $88C1 = 35009          __words.asm:546
start_70_75_73_68_3a_6d  = $88C7 = 35015          __words.asm:555
start_72_3e_61_3a_6d     = $88CC = 35020          __words.asm:563
start_72_3e_61_62_3a_6d  = $88D1 = 35025          __words.asm:571
start_72_3e_62_3a_6d     = $88D7 = 35031          __words.asm:580
start_73_77_61_70_3a_66  = $88E1 = 35041          __words.asm:594 (unused)
start_73_77_61_70_3a_6d  = $88DC = 35036          __words.asm:588


total time: 0.0091 sec.
no errors
